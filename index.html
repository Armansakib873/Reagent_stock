
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Reagent Stock Management System v2.1</title>
    <!-- XLSX for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Moment.js for date formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!-- html2canvas for JPG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- ZXing for QR/Barcode scanning -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>

       <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

   <link rel="stylesheet" href="style.css">


</head>
<body>
    <div id="alerts-container"></div>
    <div id="loading" class="loading hidden"><div class="spinner"></div></div>

    <div id="app-container">
        <header>
            <div class="container header-content">
                <div class="logo">Lab<span>Stock</span> v2.1</div>
            </div>

            <div class="author">
                <p>Developed and maintaned by - Md. Arman Hossain</p>
            </div>
        </header>

        <div class="container">
            <div class="dashboard">
                <div class="dashboard-card" id="total-reagents-card" title="View all active reagents">
                    <h3>Total Active Reagents</h3>
                    <p id="total-reagents-val">0</p>
                </div>
                <div class="dashboard-card" id="expiring-soon-card" title="View reagents expiring in 30 days">
                    <h3>Expiring Soon (30d)</h3>
                    <p id="expiring-soon-val" class="status-expiring">0</p>
                </div>
                <div class="dashboard-card" id="expired-card" title="View expired reagents">
                    <h3>Expired</h3>
                    <p id="expired-val" class="status-expired">0</p>
                </div>
            </div>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="inventory">Inventory</div>
                    <div class="tab" data-tab="consumption">Consumption Log</div>
                    <div class="tab" data-tab="stock-log">Stock Receive Log</div>
                    <div class="tab" data-tab="reports">Reports</div>
                </div>

                <!-- Inventory Tab -->
                <div class="tab-content active" id="inventory-tab">
                    <div class="card">
                        <div class="card-header">
                            <h2>Reagent Inventory</h2>
                            <div class="action-buttons">
                                <button id="add-reagent-receive-stock-btn">Add Reagent / Receive Stock</button>
                            </div>
                        </div>

                        <div class="filters">
                            <div class="filter-group"><label for="filter-name">Name:</label><input type="text" id="filter-name" class="filter-input" placeholder="Filter by name"></div>
                            <div class="filter-group"><label for="filter-lot">Lot #:</label><input type="text" id="filter-lot" class="filter-input" placeholder="Filter by Lot #"></div>
                            <div class="filter-group"><label for="filter-analyzer">Analyzer:</label><select id="filter-analyzer" class="filter-input"><option value="">All Analyzers</option></select></div>
                            <div class="filter-group"><label for="filter-status">Status:</label><select id="filter-status" class="filter-input"><option value="">All Status</option><option value="ok">OK</option><option value="expiring">Expiring Soon</option><option value="expired">Expired</option></select></div>


                            <div class="filter-group" style="display: none;"><label for="filter-expiry-start">Expiry From:</label><input type="date" id="filter-expiry-start" class="filter-input"></div>
                            <div class="filter-group" style="display: none;"><label for="filter-expiry-end">Expiry To:</label><input type="date" id="filter-expiry-end" class="filter-input"></div>
                            <button id="apply-filters-btn" style="align-self: flex-end; display: none;">Apply</button>


                            <button id="clear-filters-btn" class="btn-secondary" style="align-self: flex-end;">Reset</button>
                            <button id="toggle-deleted-reagents-btn" class="btn-secondary toggle-deleted-btn" style="align-self: flex-end;">Show Deleted</button>
                        </div>

                        <div id="reagent-bulk-actions-container" class="hidden" style="margin-bottom: 10px; display:flex; gap:10px; align-items:center;">
                            <span>Bulk Actions:</span>
                            <select id="reagent-bulk-action-select" style="width:auto;">
                                <option value="">Select Action</option>
                                <option value="soft-delete">Soft Delete Selected</option>
                            </select>
                            <button id="apply-reagent-bulk-action-btn" class="btn-warning">Apply</button>
                        </div>

                        <div class="table-responsive">
                            <table id="reagents-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all-reagents-checkbox"></th>
                                        <th>Name</th>
                                        <th>Lot #</th>
                                        <th>Analyzer</th>
                                        <th>Current Stock</th>
                                        <th>Unit</th>
                                        <th>Expiry Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reagents-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Consumption Tab -->
                <div class="tab-content" id="consumption-tab">
                    <div class="card">
                        <div class="card-header">
                            <h2>Record & View Consumption</h2>
                            <button id="add-consumption-btn">Record New Consumption (Batch)</button>
                        </div>
                        <div class="filters">
                            <div class="filter-group"><label for="consumption-filter-start">Start Date:</label><input type="date" id="consumption-filter-start" class="filter-input"></div>
                            <div class="filter-group"><label for="consumption-filter-end">End Date:</label><input type="date" id="consumption-filter-end" class="filter-input"></div>
                            <div class="filter-group"><label for="consumption-filter-reagent">Reagent:</label><select id="consumption-filter-reagent" class="filter-input"><option value="">All Reagents</option></select></div>
                            <div class="filter-group"><label for="consumption-filter-notes">Notes:</label><input type="text" id="consumption-filter-notes" class="filter-input" placeholder="Search notes"></div>
                            <button id="apply-consumption-filters-btn" style="align-self: flex-end;">Apply</button>
                            <button id="clear-consumption-filters-btn" class="btn-secondary" style="align-self: flex-end;">Clear</button>
                            <button id="toggle-deleted-consumption-btn" class="btn-secondary toggle-deleted-btn" style="align-self: flex-end;">Show Deleted</button>
                        </div>
                        <div class="table-responsive">
                            <table id="consumption-table">
                                <thead><tr><th>Date</th><th>Reagent</th><th>Lot #</th><th>Quantity</th><th>Unit</th><th>Notes</th><th>Actions</th></tr></thead>
                                <tbody id="consumption-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stock Log Tab -->
                <div class="tab-content" id="stock-log-tab">
                     <div class="card">
                        <div class="card-header">
                            <h2>Stock Receive Log</h2>
                            <button id="toggle-deleted-stocklog-btn" class="btn-secondary toggle-deleted-btn">Show Deleted</button>
                        </div>
                         <div class="filters">
                            <div class="filter-group"><label for="stocklog-filter-start">Start Date:</label><input type="date" id="stocklog-filter-start" class="filter-input"></div>
                            <div class="filter-group"><label for="stocklog-filter-end">End Date:</label><input type="date" id="stocklog-filter-end" class="filter-input"></div>
                            <div class="filter-group"><label for="stocklog-filter-reagent">Reagent:</label><select id="stocklog-filter-reagent" class="filter-input"><option value="">All Reagents</option></select></div>
                            <button id="apply-stocklog-filters-btn" style="align-self: flex-end;">Apply</button>
                            <button id="clear-stocklog-filters-btn" class="btn-secondary" style="align-self: flex-end;">Clear</button>
                        </div>
                        <div class="table-responsive">
                            <table id="stock-log-table">
                                <thead><tr><th>Date Received</th><th>Reagent Name</th><th>Lot #</th><th>Quantity Received</th><th>Unit</th><th>Notes</th><th>Recorded At</th><th>Actions</th></tr></thead>
                                <tbody id="stock-log-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-content" id="reports-tab">
                     <div class="card">
                        <div class="card-header"><h2>Reports</h2></div>
                        <div class="row">
                            <div class="col"><div class="card" style="height: 100%;">
                                <h3>Stock Status Report</h3><p>Current stock levels and status of active reagents.</p>
                                <button id="stock-report-excel-btn" style="margin-top:10px;">Export to Excel</button>
                                <button id="stock-report-jpg-btn" class="btn-secondary" style="margin-top:10px;">Export to JPG</button>
                                <div id="stock-report-render-area" class="hidden"></div>
                            </div></div>
                            <div class="col"><div class="card" style="height: 100%;">
                                <h3>Consumption History</h3><p>Export consumption for selected period.</p>
                                  <button id="consumption-report-excel-btn">Export to Excel</button>
                                <button id="consumption-report-jpg-btn" class="btn-secondary" style="margin-top:5px;">Export to JPG</button>
                                <div class="form-group" style="margin-top:10px;"><label for="report-consumption-start-date">Start Date</label><input type="date" id="report-consumption-start-date"></div>
                                <div class="form-group"><label for="report-consumption-end-date">End Date</label><input type="date" id="report-consumption-end-date"></div>
                              
                                <div id="consumption-report-render-area" class="hidden"></div>
                            </div></div>
                            <div class="col"><div class="card" style="height: 100%;">
                                <h3>Expiry Report</h3><p>Reagents expiring within a selected period.</p>
                                  <button id="expiry-report-excel-btn">Export to Excel</button>
                                <button id="expiry-report-jpg-btn" class="btn-secondary" style="margin-top:5px;">Export to JPG</button>
                                <div class="form-group" style="margin-top:10px;"><select id="expiry-period">
                                    <option value="30">Next 30 Days</option><option value="60">Next 60 Days</option>
                                    <option value="90">Next 90 Days</option><option value="all">All Future Expiry</option>
                                </select></div>
                              
                                <div id="expiry-report-render-area" class="hidden"></div>
                            </div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- Combined Add Reagent / Receive Stock Modal -->
<div id="reagent-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3 id="reagent-modal-title">Add Reagent / Receive Stock</h3>
            <button class="close-modal" data-modal-id="reagent-modal">×</button>
        </div>
        <form id="reagent-form">
            <input type="hidden" id="reagent-id">

            
                <div class="form-group form-group-relative">
                    <label for="reagent-search-name">Search Existing Reagent by Name/Lot or Select from Matches Below:</label>
                    <input type="text" id="reagent-search-name" placeholder="Type reagent name or lot to search...">
                    <div id="reagent-suggestions-dropdown" class="suggestions-dropdown hidden"></div>
                </div>

            <!-- STEP 1: Scan or Enter LOT -->
            <h4>Enter/Scan Lot & Expiry</h4>
            <div class="form-group">
                <div class="scanner-controls">
                    <button type="button" id="reagent-scanner-start-btn" class="btn-secondary">Scan Camera</button>
                    <button type="button" id="reagent-scanner-upload-btn" class="btn-secondary">Upload Image</button>
                </div>
                <input type="file" id="reagent-scanner-upload-input" accept="image/*">
                <video id="reagent-scanner-video" playsinline></video>
                <img id="reagent-scanner-preview">
            </div>
            <div class="form-group">
                <label for="reagent-scanner-raw">Raw Scan Data (Editable)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="reagent-scanner-raw" placeholder="Enter or paste raw barcode data here">
                    <button type="button" id="parse-raw-scan-data-btn" class="btn-info" style="flex-shrink: 0;">Parse</button>
                </div>
            </div>

            <hr>

            <!-- STEP 2: Identify Matching Reagent -->
            <div id="identification-stage">
                <h4>Identify or Register Reagent</h4>

                            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="reagent-lot-number">Lot Number*</label>
                        <input type="text" id="reagent-lot-number">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="expiry-date">Expiry Date*</label>
                        <input type="date" id="expiry-date">
                    </div>
                </div>
            </div>

             <!-- Toggle Register New Section -->
            <button type="button" id="toggle-register-new-fields-btn" class="btn-info" style="margin-top:10px; width:100%;">+ Register as New Reagent (or modify details for new)</button>

               <!-- STEP 3B: Register New Reagent -->
            <div id="register-new-stage" class="hidden">
                <hr>
                <h4>Register New Reagent Details</h4>
                <div class="form-group">
                    <label for="register-new-reagent-name">Reagent Name*</label>
                    <input type="text" id="register-new-reagent-name">
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="register-new-initial-stock">Initial Stock*</label>
                            <input type="number" id="register-new-initial-stock" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="register-new-unit">Unit*</label>
                            <select id="register-new-unit">
                                <option value="">Select Unit</option>
                                <option value="mL">mL</option>
                                <option value="L">L</option>
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="Tests">Tests</option>
                                <option value="Kits">Kits</option>
                                <option value="Boxes">Boxes</option>
                                <option value="Units">Units</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="register-new-description">Description (Optional)</label>
                    <input type="text" id="register-new-description">
                </div>
                <div class="form-group">
                    <label for="register-new-storage-conditions">Storage Conditions (Optional)</label>
                    <input type="text" id="register-new-storage-conditions" placeholder="e.g., 2-8°C">
                </div>
                <div class="form-group">
                    <label for="register-new-reagent-notes">Notes (Optional)</label>
                    <textarea id="register-new-reagent-notes" rows="2"></textarea>
                </div>
            </div>

                            <div id="scanned-lot-matches-container" style="margin-top:10px; max-height: 150px; overflow-y:auto;">
                    <p>Enter Lot # above or scan to see matches.</p>
                </div>



                <!-- Display when a reagent is selected or entered -->
                <div class="row" style="margin-top: 15px;">
                    <div class="col">
                        <div class="form-group">
                            <label for="selected-reagent-name">Selected Reagent Name for Action</label>
                            <input type="text" id="selected-reagent-name" readonly placeholder="Select/find existing or enter new below">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="modal-analyzer">Analyzer*</label>
                            <select id="modal-analyzer" required>
                                <option value="">Select Analyzer</option>
                                <option value="Dimension">Dimension</option>
                                <option value="Vitrous CHM">Vitrous CHM</option>
                                <option value="Vitrous IMMU">Vitrous IMMU</option>
                                <option value="Advia CP">Advia CP</option>
                                <option value="Sysmex">Sysmex</option>
                                <option value="Biorad">Biorad</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="analyzers" style="display: flex; gap: 10px; margin-top: 5px;">
                                <button type="button" id="trigger-add-analyzer-option" class="btn-secondary" style="font-size:12px; padding: 4px 8px;">Add New</button>
                                <button type="button" id="trigger-delete-analyzer-option" class="btn-secondary" style="font-size:12px; padding: 4px 8px;">Del Selected</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

           

            <!-- STEP 3A: Receive Stock (if match found) -->
            <div id="receive-stock-stage" class="hidden">
                <hr>
                <h4>Receive Stock for: <span id="receive-for-reagent-name" style="color:var(--accent-color);"></span></h4>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>Unit:</label>
                            <input type="text" id="receive-existing-unit" readonly>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Current Stock:</label>
                            <input type="text" id="receive-existing-current-stock" readonly>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="receive-quantity">Quantity to Add*</label>
                            <input type="number" id="receive-quantity" min="0.01" step="0.01">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="receive-date">Date Received*</label>
                            <input type="date" id="receive-date">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="receive-notes">Notes for this batch (Optional)</label>
                    <textarea id="receive-notes" rows="2"></textarea>
                </div>
            </div>

         

            <!-- Buttons -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                <button type="button" class="btn-secondary cancel-modal" data-modal-id="reagent-modal">Cancel</button>
                <button type="submit" id="reagent-form-submit-btn" class="btn-accent" disabled>Save</button>
            </div>
        </form>
    </div>
</div>

    <!-- Simple Reagent Edit Modal -->
    <div id="simple-reagent-edit-modal" class="modal-backdrop">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="simple-reagent-edit-modal-title">Edit Reagent Information</h3>
                <button class="close-modal" data-modal-id="simple-reagent-edit-modal">×</button>
            </div>
            <form id="simple-reagent-edit-form">
                <input type="hidden" id="simple-edit-reagent-id">
                <div class="form-group">
                    <label for="simple-edit-reagent-name">Reagent Name*</label>
                    <input type="text" id="simple-edit-reagent-name" required>
                </div>
                 <div class="form-group">
                    <label for="simple-edit-analyzer">Analyzer*</label>
                    <select id="simple-edit-analyzer" required>
                        <!-- Options will be populated by JS, similar to main modal -->
                        <option value="">Select Analyzer</option>
                        <option value="Dimension">Dimension</option>
                        <option value="Vitrous CHM">Vitrous CHM</option>
                        <option value="Vitrous IMMU">Vitrous IMMU</option>
                        <option value="Advia CP">Advia CP</option>
                        <option value="Sysmex">Sysmex</option>
                        <option value="Biorad">Biorad</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <p><em>Lot Number, Expiry Date, Stock, and Unit cannot be changed here. Use "Add Reagent / Receive Stock" for new batches or stock adjustments.</em></p>
                <div class="form-group">
                    <label for="simple-edit-description">Description</label>
                    <input type="text" id="simple-edit-description">
                </div>
                <div class="form-group">
                    <label for="simple-edit-storage-conditions">Storage Conditions</label>
                    <input type="text" id="simple-edit-storage-conditions" placeholder="e.g., 2-8°C">
                </div>
                <div class="form-group">
                    <label for="simple-edit-notes">Notes</label>
                    <textarea id="simple-edit-notes" rows="3"></textarea>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                    <button type="button" class="btn-secondary cancel-modal" data-modal-id="simple-reagent-edit-modal">Cancel</button>
                    <button type="submit" class="btn-accent">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Add/Edit Consumption Modal -->
    <div id="consumption-modal" class="modal-backdrop">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header"><h3 id="consumption-modal-title">Record Consumption</h3><button class="close-modal" data-modal-id="consumption-modal">×</button></div>
            <form id="consumption-form">
                <input type="hidden" id="consumption-edit-id">
                <div id="consumption-items-container"></div>
                <button type="button" id="add-consumption-item-btn" class="btn-secondary" style="margin-top:10px;">Add Another Reagent</button>
                <hr style="margin: 20px 0;">
                <div class="form-group"><label for="consumption-batch-date">Date of Consumption*</label><input type="date" id="consumption-batch-date" required></div>
                <div class="form-group"><label for="consumption-batch-notes">Overall Notes (Optional)</label><textarea id="consumption-batch-notes" rows="2"></textarea></div>
                <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;"><button type="button" class="btn-secondary cancel-modal" data-modal-id="consumption-modal">Cancel</button><button type="submit" class="btn-accent">Save Consumption(s)</button></div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal-backdrop">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><h3>Confirm Action</h3><button class="close-modal" data-modal-id="delete-confirm-modal">×</button></div>
            <p id="delete-confirm-message">Are you sure you want to delete this item? This action cannot be undone.</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;"><button type="button" class="btn-secondary cancel-modal" data-modal-id="delete-confirm-modal">Cancel</button><button id="confirm-delete-btn" class="btn-warning">Confirm</button></div>
        </div>
    </div>

    <script>
    // --- START OF SCRIPT ---
    const loadingIndicator = document.getElementById('loading');
    const alertsContainer = document.getElementById('alerts-container');

    // --- Supabase Setup ---
    const SUPABASE_URL = 'https://afsafginwgrkflykgshe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmc2FmZ2lud2dya2ZseWtnc2hlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1NTAyMzQsImV4cCI6MjA2MzEyNjIzNH0.CeIzbdyxL8QOcs0mbR-29Xc9wtEhYxQ7QOIKSH_mZRI';

    if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
        console.error("Supabase URL or Anon Key is not configured. Please update the script.");
        alert("Supabase is not configured. Application will not work correctly. Please check console.");
    }
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global state
    let reagentsCache = [];
    let consumptionCache = [];
    let stockLogCache = [];
    let deleteTarget = { id: null, ids: null, type: null, permanent: false };
    let showDeletedReagents = false;
    let showDeletedConsumption = false;
    let showDeletedStockLog = false;

    // --- ZXing Scanner Instance ---
    const codeReader = new ZXing.BrowserMultiFormatReader();
    let currentModalVideoStream = null;

    // --- Combined Modal State ---
    let currentModalIntent = 'idle'; // 'idle', 'identifying_existing', 'receiving_selected', 'registering_new'
    let selectedExistingReagent = null; // Stores the full reagent object if one is selected for receiving stock

   // DOM Element references for Combined Modal (initialized in initCombinedModalElements)
    let reagentIdInput, reagentLotInput, expiryDateInput, reagentSearchNameInput, suggestionsDropdownEl;
    let scannedLotMatchesContainerEl, selectedReagentNameInputEl, modalAnalyzerSelect; // Renamed selectedReagentNameInput to El to avoid conflict
    let receiveStockStageEl, registerNewStageEl, toggleRegisterNewFieldsBtn;
    let receiveQuantityInput, receiveDateInput, receiveExistingUnitInput, receiveExistingCurrentStockInput, receiveNotesInput, receiveForReagentNameEl;
    let registerNewNameInput, registerNewInitialStockInput, registerNewUnitSelect, registerNewDescInput, registerNewStorageInput, registerNewNotesInput;
    let reagentFormSubmitBtn, rawScanInputEl, parseRawScanBtn;

    // DOM Element references for Simple Edit Modal
    let simpleEditReagentIdInput, simpleEditReagentNameInput, simpleEditAnalyzerSelect, simpleEditDescInput, simpleEditStorageInput, simpleEditNotesInput;


    // --- Utility Functions ---
    function showLoading() { if(loadingIndicator) loadingIndicator.classList.remove('hidden'); }
    function hideLoading() { if(loadingIndicator) loadingIndicator.classList.add('hidden'); }

    function showAlert(message, type = 'success', duration = 3500) {
        if (!alertsContainer) return;
        const alertDiv = document.createElement('div');
        alertDiv.classList.add('alert', `alert-${type}`);
        const messageP = document.createElement('p');
        messageP.textContent = message;
        const closeBtn = document.createElement('button');
        closeBtn.classList.add('alert-close');
        closeBtn.innerHTML = '×';
        closeBtn.onclick = () => alertDiv.remove();
        alertDiv.appendChild(messageP);
        alertDiv.appendChild(closeBtn);
        alertsContainer.appendChild(alertDiv);
        setTimeout(() => {
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 300);
        }, duration);
    }
    function formatDate(dateString, format = 'YYYY-MM-DD') { return dateString ? moment(dateString).format(format) : ''; }


    // NEW Debounce Function
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
        showLoading();
        initTabs();
        initMainEventListeners();
        initCombinedModalElements(); 
        initSimpleReagentEditModalElements();
        initScannerControls();
        initReagentSearch();
        initCombinedModalSpecificEventListeners(); 
        initSimpleReagentEditModalEventListeners();

        await loadAllData(); // This populates tables and filter dropdowns
        updateDashboard();
        initReportDates();
        hideLoading();
    }

    function initCombinedModalElements() {
        reagentIdInput = document.getElementById('reagent-id');
        reagentLotInput = document.getElementById('reagent-lot-number');
        expiryDateInput = document.getElementById('expiry-date');
        rawScanInputEl = document.getElementById('reagent-scanner-raw');
        parseRawScanBtn = document.getElementById('parse-raw-scan-data-btn');

        reagentSearchNameInput = document.getElementById('reagent-search-name');
        suggestionsDropdownEl = document.getElementById('reagent-suggestions-dropdown');
        scannedLotMatchesContainerEl = document.getElementById('scanned-lot-matches-container');
        selectedReagentNameInputEl = document.getElementById('selected-reagent-name');
        modalAnalyzerSelect = document.getElementById('modal-analyzer');

        receiveStockStageEl = document.getElementById('receive-stock-stage');
        registerNewStageEl = document.getElementById('register-new-stage');
        toggleRegisterNewFieldsBtn = document.getElementById('toggle-register-new-fields-btn');
        receiveForReagentNameEl = document.getElementById('receive-for-reagent-name');

        receiveQuantityInput = document.getElementById('receive-quantity');
        receiveDateInput = document.getElementById('receive-date');
        receiveNotesInput = document.getElementById('receive-notes');
        receiveExistingUnitInput = document.getElementById('receive-existing-unit');
        receiveExistingCurrentStockInput = document.getElementById('receive-existing-current-stock');

        registerNewNameInput = document.getElementById('register-new-reagent-name');
        registerNewInitialStockInput = document.getElementById('register-new-initial-stock');
        registerNewUnitSelect = document.getElementById('register-new-unit');
        registerNewDescInput = document.getElementById('register-new-description');
        registerNewStorageInput = document.getElementById('register-new-storage-conditions');
        registerNewNotesInput = document.getElementById('register-new-reagent-notes');

        reagentFormSubmitBtn = document.getElementById('reagent-form-submit-btn');
    }

    function initSimpleReagentEditModalElements() {
        simpleEditReagentIdInput = document.getElementById('simple-edit-reagent-id');
        simpleEditReagentNameInput = document.getElementById('simple-edit-reagent-name');
        simpleEditAnalyzerSelect = document.getElementById('simple-edit-analyzer');
        simpleEditDescInput = document.getElementById('simple-edit-description');
        simpleEditStorageInput = document.getElementById('simple-edit-storage-conditions');
        simpleEditNotesInput = document.getElementById('simple-edit-notes');
    }


   function initCombinedModalSpecificEventListeners() {
    const addReagentBtn = document.getElementById('add-reagent-receive-stock-btn');
    if(addReagentBtn) addReagentBtn.addEventListener('click', openCombinedReagentModal);
    
    const reagentForm = document.getElementById('reagent-form');
    if(reagentForm) reagentForm.addEventListener('submit', handleCombinedReagentFormSubmit);

    if (reagentLotInput) {
        reagentLotInput.addEventListener('input', async () => { 
            // Lot input is now always editable, so this listener is always active
            if (reagentLotInput.value.trim() !== "") {
                await findReagentsByScannedLot(reagentLotInput.value.trim());
            } else {
                if(scannedLotMatchesContainerEl) scannedLotMatchesContainerEl.innerHTML = '<p>Enter Lot # to see matches.</p>';
                 selectedExistingReagent = null; // Clear selection if lot is cleared
                 if(reagentIdInput) reagentIdInput.value = '';
                 if(selectedReagentNameInputEl) selectedReagentNameInputEl.value = '';
            }
            updateModalUIBasedOnState();
        });
    }
    if(expiryDateInput) {
         expiryDateInput.addEventListener('change', updateModalUIBasedOnState);
    }
    if(modalAnalyzerSelect){
        modalAnalyzerSelect.addEventListener('change', updateModalUIBasedOnState);
    }
    if(registerNewNameInput) registerNewNameInput.addEventListener('input', updateModalUIBasedOnState);
    if(registerNewInitialStockInput) registerNewInitialStockInput.addEventListener('input', updateModalUIBasedOnState);
    if(registerNewUnitSelect) registerNewUnitSelect.addEventListener('change', updateModalUIBasedOnState);
    if(receiveQuantityInput) receiveQuantityInput.addEventListener('input', updateModalUIBasedOnState);
    if(receiveDateInput) receiveDateInput.addEventListener('change', updateModalUIBasedOnState);


    if (parseRawScanBtn) {
        parseRawScanBtn.addEventListener('click', () => {
            if (rawScanInputEl && rawScanInputEl.value.trim()) {
                parseReagentBarcode(rawScanInputEl.value.trim());
            } else {
                showAlert("Raw scan data field is empty.", "info");
            }
        });
    }

    if (toggleRegisterNewFieldsBtn) {
        toggleRegisterNewFieldsBtn.addEventListener('click', () => {
            selectedExistingReagent = null; // Clear any existing selection
            if(reagentIdInput) reagentIdInput.value = '';
            if(selectedReagentNameInputEl) selectedReagentNameInputEl.value = ''; // Clear display name

            currentModalIntent = 'registering_new';
            // Pre-fill new name if search bar had text and lot/expiry from top fields
            if (registerNewNameInput && reagentSearchNameInput && registerNewNameInput.value === '' && reagentSearchNameInput.value.trim()) {
                 registerNewNameInput.value = reagentSearchNameInput.value.trim();
            }
            // If lot/expiry were already entered/scanned, they remain.
            // Analyzer might also be pre-selected.
            updateModalUIBasedOnState();
        });
    }

    const modalTriggerAddAnalyzerBtn = document.getElementById('trigger-add-analyzer-option');
    const modalTriggerDeleteAnalyzerBtn = document.getElementById('trigger-delete-analyzer-option');

    if (modalTriggerAddAnalyzerBtn) {
        modalTriggerAddAnalyzerBtn.addEventListener('click', () => {
            const newAnalyzerName = prompt("Enter name for the new analyzer option (this session only):");
            if (newAnalyzerName && newAnalyzerName.trim() !== "") {
                addAnalyzerOptionToDropdown(modalAnalyzerSelect, newAnalyzerName.trim(), newAnalyzerName.trim(), true);
            }
        });
    }
    if (modalTriggerDeleteAnalyzerBtn) {
        modalTriggerDeleteAnalyzerBtn.addEventListener('click', () => deleteSelectedAnalyzerOptionFromDropdown(modalAnalyzerSelect));
    }
}
    function initSimpleReagentEditModalEventListeners() {
        const form = document.getElementById('simple-reagent-edit-form');
        if (form) form.addEventListener('submit', handleSimpleReagentEditFormSubmit);
    }


    async function loadAllData() {
        showLoading();
        try {
            const [reagentsResult, consumptionResult, stockLogResult] = await Promise.all([
                supabase.from('reagents').select('*').order('name', { ascending: true }),
                supabase.from('consumption_log').select('*').order('date', { ascending: false }),
                supabase.from('stock_receive_log').select('*').order('date_received', { ascending: false })
            ]);

            if (reagentsResult.error) throw reagentsResult.error;
            reagentsCache = reagentsResult.data || [];

            if (consumptionResult.error) throw consumptionResult.error;
            consumptionCache = consumptionResult.data || [];

            if (stockLogResult.error) throw stockLogResult.error;
            stockLogCache = stockLogResult.data || [];

            populateReagentsTable();
            populateConsumptionTable();
            populateStockLogTable();
            populateFilterDropdowns();
            updateDashboard();

        } catch (error) {
            console.error("Error loading data from Supabase:", error);
            showAlert(`Error loading data: ${error.message}`, 'error', 10000);
        } finally {
            hideLoading();
        }
    }
    function populateFilterDropdowns() {
        populateAnalyzerFilter();
        populateConsumptionReagentFilter();
        populateStockLogReagentFilter();
        // Also populate analyzer dropdown in simple edit modal if needed (or do it on open)
        populateAnalyzerDropdown(simpleEditAnalyzerSelect, false); // Populate simple edit modal's analyzer dropdown
    }
    function initTabs() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const activeContent = document.getElementById(`${tabId}-tab`);
                if(activeContent) activeContent.classList.add('active');
            });
        });
    }
    function setActiveTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        const tabToActivate = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (tabToActivate) tabToActivate.classList.add('active');
        
        const contentToActivate = document.getElementById(`${tabId}-tab`);
        if (contentToActivate) contentToActivate.classList.add('active');
    }

 function initMainEventListeners() {
    // Dashboard card clicks
    const totalReagentsCard = document.getElementById('total-reagents-card');
    const expiringSoonCard = document.getElementById('expiring-soon-card');
    const expiredCard = document.getElementById('expired-card');

    if(totalReagentsCard) totalReagentsCard.addEventListener('click', () => {
        clearReagentFilters(); 
        setActiveTab('inventory');
    });
    if(expiringSoonCard) expiringSoonCard.addEventListener('click', () => {
        clearReagentFilters(false); 
        if(document.getElementById('filter-status')) document.getElementById('filter-status').value = 'expiring';
        applyReagentFilters();
        setActiveTab('inventory');
    });
    if(expiredCard) expiredCard.addEventListener('click', () => {
        clearReagentFilters(false); 
        if(document.getElementById('filter-status')) document.getElementById('filter-status').value = 'expired';
        applyReagentFilters();
        setActiveTab('inventory');
    });

    // --- Inventory Tab Filters (Live Filtering) ---
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const selectAllReagentsCheckbox = document.getElementById('select-all-reagents-checkbox');
    const applyReagentBulkActionBtn = document.getElementById('apply-reagent-bulk-action-btn');
    const toggleDeletedReagentsBtn = document.getElementById('toggle-deleted-reagents-btn');

    if(clearFiltersBtn) clearFiltersBtn.addEventListener('click', () => clearReagentFilters()); // Reset button still useful
    if(selectAllReagentsCheckbox) selectAllReagentsCheckbox.addEventListener('change', handleSelectAllReagentsChange);
    if(applyReagentBulkActionBtn) applyReagentBulkActionBtn.addEventListener('click', handleReagentBulkAction);
    if(toggleDeletedReagentsBtn) toggleDeletedReagentsBtn.addEventListener('click', () => {
        showDeletedReagents = !showDeletedReagents;
        toggleDeletedReagentsBtn.textContent = showDeletedReagents ? 'Hide Deleted' : 'Show Deleted';
        populateReagentsTable(); // Apply current filters with new show/hide deleted state
    });

    // Event listeners for live filtering on inventory tab
    const filterNameInput = document.getElementById('filter-name');
    const filterLotInput = document.getElementById('filter-lot');
    const filterAnalyzerSelect = document.getElementById('filter-analyzer');
    const filterStatusSelect = document.getElementById('filter-status');
    const filterExpiryStartInput = document.getElementById('filter-expiry-start');
    const filterExpiryEndInput = document.getElementById('filter-expiry-end');

    // REMOVED: const applyFiltersBtn = document.getElementById('apply-filters-btn');
    // REMOVED: if(applyFiltersBtn) applyFiltersBtn.addEventListener('click', applyReagentFilters);

    if (filterNameInput) filterNameInput.addEventListener('input', debounce(applyReagentFilters, 350)); // Debounce text inputs
    if (filterLotInput) filterLotInput.addEventListener('input', debounce(applyReagentFilters, 350));   // Debounce text inputs
    if (filterAnalyzerSelect) filterAnalyzerSelect.addEventListener('change', applyReagentFilters);    // 'change' for select
    if (filterStatusSelect) filterStatusSelect.addEventListener('change', applyReagentFilters);        // 'change' for select
    if (filterExpiryStartInput) filterExpiryStartInput.addEventListener('change', applyReagentFilters); // 'change' for date
    if (filterExpiryEndInput) filterExpiryEndInput.addEventListener('change', applyReagentFilters);     // 'change' for date


    // --- Consumption Tab Event Listeners (remain as they were) ---
    const addConsumptionBtn = document.getElementById('add-consumption-btn');
    const consumptionForm = document.getElementById('consumption-form');
    const addConsumptionItemBtn = document.getElementById('add-consumption-item-btn');
    const applyConsumptionFiltersBtn = document.getElementById('apply-consumption-filters-btn');
    const clearConsumptionFiltersBtn = document.getElementById('clear-consumption-filters-btn');
    const toggleDeletedConsumptionBtn = document.getElementById('toggle-deleted-consumption-btn');

    if(addConsumptionBtn) addConsumptionBtn.addEventListener('click', () => openConsumptionModal());
    if(consumptionForm) consumptionForm.addEventListener('submit', handleConsumptionFormSubmit);
    if(addConsumptionItemBtn) addConsumptionItemBtn.addEventListener('click', addConsumptionItemRow);
    if(applyConsumptionFiltersBtn) applyConsumptionFiltersBtn.addEventListener('click', applyConsumptionFilters);
    if(clearConsumptionFiltersBtn) clearConsumptionFiltersBtn.addEventListener('click', clearConsumptionFilters);
    if(toggleDeletedConsumptionBtn) toggleDeletedConsumptionBtn.addEventListener('click', () => {
        showDeletedConsumption = !showDeletedConsumption;
        toggleDeletedConsumptionBtn.textContent = showDeletedConsumption ? 'Hide Deleted' : 'Show Deleted';
        populateConsumptionTable();
    });


    // --- Stock Log Tab Filters Event Listeners (remain as they were) ---
    const applyStocklogFiltersBtn = document.getElementById('apply-stocklog-filters-btn');
    const clearStocklogFiltersBtn = document.getElementById('clear-stocklog-filters-btn');
    const toggleDeletedStocklogBtn = document.getElementById('toggle-deleted-stocklog-btn');

    if(applyStocklogFiltersBtn) applyStocklogFiltersBtn.addEventListener('click', applyStockLogFilters);
    if(clearStocklogFiltersBtn) clearStocklogFiltersBtn.addEventListener('click', clearStockLogFilters);
    if(toggleDeletedStocklogBtn) toggleDeletedStocklogBtn.addEventListener('click', () => {
        showDeletedStockLog = !showDeletedStockLog;
        toggleDeletedStocklogBtn.textContent = showDeletedStockLog ? 'Hide Deleted' : 'Show Deleted';
        populateStockLogTable();
    });

    // --- Report Buttons Event Listeners (remain as they were) ---
    const stockReportExcelBtn = document.getElementById('stock-report-excel-btn');
    // ... (all other report button listeners) ...
    if(stockReportExcelBtn) stockReportExcelBtn.addEventListener('click', () => generateStockReport(false));
    // ... (ensure all report button listeners are present here)


    // --- Generic Modal Close Buttons (remain as they were) ---
    document.querySelectorAll('.close-modal, .cancel-modal').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const modalId = e.target.dataset.modalId;
            if(modalId) closeModal(modalId);
            else closeAllModals(); 
        });
    });
    
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    if(confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
}


    function initReportDates() {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const reportConsumptionStartDate = document.getElementById('report-consumption-start-date');
        const reportConsumptionEndDate = document.getElementById('report-consumption-end-date');
        if(reportConsumptionStartDate) reportConsumptionStartDate.valueAsDate = thirtyDaysAgo;
        if(reportConsumptionEndDate) reportConsumptionEndDate.valueAsDate = today;
    }

    // --- Scanner Related Functions ---
     function initScannerControls() {
        const startBtn = document.getElementById('reagent-scanner-start-btn');
        const uploadBtn = document.getElementById('reagent-scanner-upload-btn');
        
        if(startBtn) startBtn.addEventListener('click', () => {
            resetReagentScannerUIOnlyVisuals();
            startReagentBarcodeScanner();
        });
        if(uploadBtn) uploadBtn.addEventListener('click', () => {
            resetReagentScannerUIOnlyVisuals();
            let oldInput = document.getElementById('reagent-scanner-upload-input');
            if (oldInput && oldInput.parentNode) { 
                let parent = oldInput.parentNode;
                let newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.id = 'reagent-scanner-upload-input';
                newInput.accept = 'image/*';
                newInput.style.display = 'none';
                newInput.addEventListener('change', handleReagentBarcodeImageUpload);
                parent.replaceChild(newInput, oldInput); // Replace
                newInput.click(); // Trigger click on the new input
            } else {
                // Fallback: if no old input, try to find and click existing one.
                const fileInput = document.getElementById('reagent-scanner-upload-input');
                if(fileInput) fileInput.click();
                else console.error("File input for scanner not found.");
            }
        });
        // Ensure initial file input has listener
        const initialFileInput = document.getElementById('reagent-scanner-upload-input');
        if(initialFileInput) initialFileInput.addEventListener('change', handleReagentBarcodeImageUpload);
    }

    function resetReagentScannerUIOnlyVisuals() {
        const previewElement = document.getElementById('reagent-scanner-preview');
        if (previewElement) {
            previewElement.src = '#';
            previewElement.style.display = 'none';
        }
        const videoElement = document.getElementById('reagent-scanner-video');
        if (videoElement) {
            videoElement.style.display = 'none';
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
        }
        // Don't clear reagentLotInput or expiryDateInput here, only raw scan.
        if(rawScanInputEl) rawScanInputEl.value = ''; 
    }


    async function startReagentBarcodeScanner() {
        const videoElement = document.getElementById('reagent-scanner-video');
        if(!videoElement || !rawScanInputEl) return;

        videoElement.style.display = 'block';
        const previewEl = document.getElementById('reagent-scanner-preview');
        if(previewEl) previewEl.style.display = 'none';
        rawScanInputEl.value = '';

        try {
            if (currentModalVideoStream) {
                currentModalVideoStream.getTracks().forEach(track => track.stop());
            }
            codeReader.reset(); // Reset previous state
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            currentModalVideoStream = stream;
            videoElement.srcObject = stream;
            await videoElement.play();

            codeReader.decodeFromStream(stream, videoElement, (result, err) => {
                if (result) {
                    rawScanInputEl.value = result.getText();
                    parseReagentBarcode(result.getText()); 
                    stopReagentBarcodeScanner();
                }
                 if (err && !(err instanceof ZXing.NotFoundException) && !(err instanceof ZXing.ChecksumException) && !(err instanceof ZXing.FormatException) ) {
                    console.warn("Scanner minor error (e.g. not found):", err.message); // Downgraded to warn for common non-fatal scan issues
                } else if (err) {
                    console.error("Scanner critical error:", err);
                }
            });
        } catch (err) {
            console.error("Error starting camera for scanner:", err);
            showAlert('Camera access failed. Ensure permissions are granted and no other app is using the camera.', 'error');
            if(videoElement) videoElement.style.display = 'none';
        }
    }

    function stopReagentBarcodeScanner() {
        const videoElement = document.getElementById('reagent-scanner-video');
        if (currentModalVideoStream) {
            currentModalVideoStream.getTracks().forEach(track => track.stop());
            currentModalVideoStream = null;
        }
        if(videoElement) {
            videoElement.srcObject = null; // Important to release camera
            videoElement.style.display = 'none';
        }
        codeReader.reset(); // Reset ZXing reader state
    }

    async function handleReagentBarcodeImageUpload(event) {
        const file = event.target.files[0];
        if (!file) {
            if (event.target) event.target.value = null;
            return;
        }
        const previewElement = document.getElementById('reagent-scanner-preview');
        if(!previewElement || !rawScanInputEl) return;

        previewElement.src = URL.createObjectURL(file);
        previewElement.style.display = 'block';
        const videoEl = document.getElementById('reagent-scanner-video');
        if(videoEl) videoEl.style.display = 'none';
        stopReagentBarcodeScanner(); // Stop camera if it was running
        rawScanInputEl.value = '';

        try {
            // Ensure codeReader is initialized
            const result = await codeReader.decodeFromImage(previewElement); 
            if (result) {
                rawScanInputEl.value = result.getText();
                parseReagentBarcode(result.getText());
            } else {
                 showAlert('No barcode found in the uploaded image.', 'info');
            }
        } catch (err) {
            console.error("Error decoding image:", err);
            showAlert('Could not decode barcode from image. Try a clearer image or ensure barcode is well visible.', 'error');
            rawScanInputEl.value = 'Error decoding image.';
        } finally {
            if (event.target) event.target.value = null; // Reset file input for next upload
        }
    }

       function parseReagentBarcode(data) {
        console.log("Raw barcode data for reagent modal:", data);
        let lotFound = null, expiryFound = null;

        // Normalize GS1 group separator (ASCII 29) if present
        const cleanData = data.replace(/\u001D/g, '␝'); // Using ␝ as a visible separator for regex

        // Attempt to extract LOT (AI 10) - looking for '10' followed by characters until a separator or end
        // Taking the last 4 characters of the matched lot string as per original scanner.html logic
        const lotMatch = cleanData.match(/10([^\x1D␝]+)/);
        if (lotMatch && lotMatch[1]) {
            const fullLot = lotMatch[1].trim();
            if (fullLot.length >= 4) {
                lotFound = fullLot.slice(-4);
            } else {
                lotFound = fullLot; // If less than 4 chars, take all
            }
            document.getElementById('reagent-lot-number').value = lotFound;
            console.log("Found lot:", lotFound, "(from full:", fullLot,")");
        }

        // Attempt to extract EXPIRY (AI 17) - expecting YYMMDD format
        const expiryMatch = cleanData.match(/17(\d{6})/);
        if (expiryMatch && expiryMatch[1]) {
            const rawExpiry = expiryMatch[1]; // Should be YYMMDD
            const year = `20${rawExpiry.substring(0, 2)}`;
            const month = rawExpiry.substring(2, 4);
            const day = rawExpiry.substring(4, 6);

            // Basic validation for date components
            if (parseInt(month) >= 1 && parseInt(month) <= 12 && parseInt(day) >= 1 && parseInt(day) <= 31) {
                 expiryFound = `${year}-${month}-${day}`;
                 document.getElementById('expiry-date').value = expiryFound;
                 console.log("Found expiry:", expiryFound);
            } else {
                console.warn("Parsed expiry date components seem invalid:", year, month, day);
            }
        }

        if (!lotFound && !expiryFound) {
            showAlert("Could not extract valid LOT or EXPIRY from the scanned data. Please check barcode format or enter manually.", 'warning');
        } else if (!lotFound) {
            showAlert("EXPIRY extracted, but LOT not found. Please check or enter LOT manually.", 'warning');
        } else if (!expiryFound) {
            showAlert("LOT extracted, but EXPIRY not found. Please check or enter EXPIRY manually.", 'warning');
        } else {
            showAlert("LOT and EXPIRY extracted successfully!", 'success');
        }
    }


 async function findReagentsByScannedLot(lotNumber) {
    if (!scannedLotMatchesContainerEl || !reagentIdInput || !selectedReagentNameInputEl || !reagentLotInput || !expiryDateInput) return;
    
    scannedLotMatchesContainerEl.innerHTML = '';
    // DO NOT reset selectedExistingReagent here automatically.
    // User might be typing a lot that partially matches, then corrects it.
    // Selection should only change on explicit click of a match or search result.

    if (!lotNumber || lotNumber.trim() === "") {
        scannedLotMatchesContainerEl.innerHTML = '<p>Enter Lot # to see matches.</p>';
        // If lot is cleared by user, then clear selection
        if (selectedExistingReagent) {
            selectedExistingReagent = null;
            reagentIdInput.value = '';
            selectedReagentNameInputEl.value = '';
        }
        updateModalUIBasedOnState();
        return;
    }
    
    let message = "";
    const matchingReagents = reagentsCache.filter(r => !r.is_deleted && r.lot_number && r.lot_number.toLowerCase() === lotNumber.toLowerCase());
    
    if (matchingReagents.length > 0) {
        message = `<p>Found ${matchingReagents.length} existing reagent(s) with Lot #<b>${lotNumber}</b>. Click to select for receiving stock:</p>`;
        matchingReagents.forEach(reagent => {
             message += `<div class="match-item" data-reagent-id="${reagent.id}">
                        <strong>${reagent.name}</strong> (${reagent.analyzer})
                        <small>Current Stock: ${reagent.current_stock} ${reagent.unit} | Expires: ${formatDate(reagent.expiry_date)}</small>
                     </div>`;
        });
        // REMOVED: Auto-selection if matchingReagents.length === 1
    } else {
        message = `<p>No existing active reagent found for Lot #<b>${lotNumber}</b>. You may need to register it as new.</p>`;
        // If the entered lot number does not match the currently selected reagent's lot, clear the selection.
        if (selectedExistingReagent && selectedExistingReagent.lot_number && selectedExistingReagent.lot_number.toLowerCase() !== lotNumber.toLowerCase()) {
            selectedExistingReagent = null;
            reagentIdInput.value = '';
            selectedReagentNameInputEl.value = '';
            // Reset receive stock specific fields
            if(receiveExistingUnitInput) receiveExistingUnitInput.value = '';
            if(receiveExistingCurrentStockInput) receiveExistingCurrentStockInput.value = '';
            if(receiveForReagentNameEl) receiveForReagentNameEl.textContent = '';
        }
    }
    scannedLotMatchesContainerEl.innerHTML = message;
    document.querySelectorAll('#scanned-lot-matches-container .match-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('#scanned-lot-matches-container .match-item.selected').forEach(sel => sel.classList.remove('selected'));
            this.classList.add('selected');
            selectExistingReagentById(this.dataset.reagentId); // This will set selectedExistingReagent
        });
    });
    updateModalUIBasedOnState();
}

     function initReagentSearch() {
        if(!reagentSearchNameInput || !suggestionsDropdownEl) return;
        
        reagentSearchNameInput.addEventListener('input', () => {
            const searchTerm = reagentSearchNameInput.value.toLowerCase();
            suggestionsDropdownEl.innerHTML = '';
            suggestionsDropdownEl.classList.add('hidden');

            if (searchTerm.length < 1) return;

            const filtered = reagentsCache.filter(r => !r.is_deleted &&
                (r.name.toLowerCase().includes(searchTerm) || (r.lot_number && r.lot_number.toLowerCase().includes(searchTerm)))
            ).slice(0, 10); // Limit suggestions

            if (filtered.length > 0) {
                filtered.forEach(reagent => {
                    const div = document.createElement('div');
                    div.textContent = `${reagent.name} (${reagent.analyzer || 'N/A'}) - Lot: ${reagent.lot_number || 'N/A'} | Expires: ${formatDate(reagent.expiry_date)}`;
                    div.dataset.reagentId = reagent.id;
                    div.addEventListener('click', () => {
                        selectExistingReagentById(reagent.id); // This sets selectedExistingReagent
                        suggestionsDropdownEl.classList.add('hidden');
                        reagentSearchNameInput.value = reagent.name; 
                        
                        // Clear lot match visual selection if a search result is clicked
                        document.querySelectorAll('#scanned-lot-matches-container .match-item.selected').forEach(sel => sel.classList.remove('selected'));
                        // Update lot matches based on the selected reagent's lot
                        if(reagent.lot_number) findReagentsByScannedLot(reagent.lot_number);
                    });
                    suggestionsDropdownEl.appendChild(div);
                });
                suggestionsDropdownEl.classList.remove('hidden');
            }
        });
        // Hide dropdown on outside click
        document.addEventListener('click', (e) => {
            if (suggestionsDropdownEl && !reagentSearchNameInput.contains(e.target) && !suggestionsDropdownEl.contains(e.target)) {
                suggestionsDropdownEl.classList.add('hidden');
            }
        });
    }

  function selectExistingReagentById(reagentId_str) {
    const reagentId = reagentId_str;
    const reagent = reagentsCache.find(r => r.id.toString() === reagentId.toString());

    if (reagent && reagentIdInput && selectedReagentNameInputEl && modalAnalyzerSelect && reagentLotInput && expiryDateInput && receiveExistingUnitInput && receiveExistingCurrentStockInput && receiveDateInput && receiveForReagentNameEl) {
        selectedExistingReagent = reagent; 
        reagentIdInput.value = selectedExistingReagent.id; 

        selectedReagentNameInputEl.value = selectedExistingReagent.name; 
        modalAnalyzerSelect.value = selectedExistingReagent.analyzer;
        // Only update Lot and Expiry from selected if they were empty or user explicitly selected
        // This allows user to type a lot, see matches, select one, and the typed lot (if different) can be for a NEW entry.
        // For now, if they click a match, we assume they want THAT match's details.
        reagentLotInput.value = selectedExistingReagent.lot_number || '';
        expiryDateInput.value = selectedExistingReagent.expiry_date ? formatDate(selectedExistingReagent.expiry_date) : '';
        
        receiveExistingUnitInput.value = selectedExistingReagent.unit;
        receiveExistingCurrentStockInput.value = selectedExistingReagent.current_stock;
        if(receiveDateInput) receiveDateInput.valueAsDate = new Date(); 
        if(receiveForReagentNameEl) receiveForReagentNameEl.textContent = selectedExistingReagent.name;

        currentModalIntent = 'receiving_selected'; 
        updateModalUIBasedOnState();
        
        if(suggestionsDropdownEl) suggestionsDropdownEl.classList.add('hidden');
        if(reagentSearchNameInput) reagentSearchNameInput.value = selectedExistingReagent.name; 
    } else {
        console.error("Failed to select reagent or DOM elements missing. Reagent:", reagent);
        if(!reagent) showAlert("Selected reagent data not found in cache.", "error");
    }
}


  function updateModalUIBasedOnState() {
    if (!reagentLotInput || !expiryDateInput || !modalAnalyzerSelect ||
        !receiveStockStageEl || !registerNewStageEl || !toggleRegisterNewFieldsBtn ||
        !selectedReagentNameInputEl || !reagentFormSubmitBtn) {
        console.error("Cannot update modal UI: one or more critical elements not found.");
        return;
    }

    // Lot and Expiry are always editable in this modal flow
    reagentLotInput.readOnly = false;
    expiryDateInput.readOnly = false;

    // Analyzer is disabled only if specifically receiving stock for a selected existing reagent
    modalAnalyzerSelect.disabled = (currentModalIntent === 'receiving_selected' && !!selectedExistingReagent);


    // Show/Hide stages based on intent
    receiveStockStageEl.classList.toggle('hidden', currentModalIntent !== 'receiving_selected');
    registerNewStageEl.classList.toggle('hidden', currentModalIntent !== 'registering_new');
    
    // Visibility of "Register New" button
    toggleRegisterNewFieldsBtn.classList.toggle('hidden', currentModalIntent === 'registering_new');
    
    // Manage "Selected Reagent Name for Action" field (selectedReagentNameInputEl)
    if (currentModalIntent === 'receiving_selected' && selectedExistingReagent) {
        selectedReagentNameInputEl.value = selectedExistingReagent.name;
        selectedReagentNameInputEl.placeholder = "Receiving stock for this reagent";
    } else if (currentModalIntent === 'registering_new') {
        selectedReagentNameInputEl.value = registerNewNameInput.value || reagentSearchNameInput.value || '';
        selectedReagentNameInputEl.placeholder = "Name for the new reagent being registered";
    } else { // idle, identifying_existing
        selectedReagentNameInputEl.value = reagentSearchNameInput.value || '';
        selectedReagentNameInputEl.placeholder = "Select/find existing or enter new below";
    }


    // Submit button text and state
    let isFormValidForSubmit = false;
    if (currentModalIntent === 'receiving_selected' && selectedExistingReagent) {
        reagentFormSubmitBtn.textContent = `Add Stock to "${selectedExistingReagent.name}"`;
        isFormValidForSubmit =
            receiveQuantityInput && receiveQuantityInput.value && parseFloat(receiveQuantityInput.value) > 0 &&
            receiveDateInput && receiveDateInput.value;
    } else if (currentModalIntent === 'registering_new') {
        reagentFormSubmitBtn.textContent = "Register New Reagent";
        isFormValidForSubmit =
            registerNewNameInput && registerNewNameInput.value.trim() &&
            modalAnalyzerSelect && modalAnalyzerSelect.value &&
            reagentLotInput && reagentLotInput.value.trim() &&
            expiryDateInput && expiryDateInput.value &&
            registerNewInitialStockInput && registerNewInitialStockInput.value && parseFloat(registerNewInitialStockInput.value) >= 0 &&
            registerNewUnitSelect && registerNewUnitSelect.value;
        
        // If registering new, prefill name from search bar if it makes sense and new name field is empty
        if (registerNewNameInput.value.trim() === '' && reagentSearchNameInput.value.trim() && !selectedExistingReagent) {
            // registerNewNameInput.value = reagentSearchNameInput.value.trim(); // This might auto-trigger revalidation, be careful
        }
    } else { // 'idle' or 'identifying_existing'
        reagentFormSubmitBtn.textContent = "Save"; // Or "Next", "Proceed"
        isFormValidForSubmit = false; // Cannot save in these intermediate states directly
    }
    reagentFormSubmitBtn.disabled = !isFormValidForSubmit;
}

     function openCombinedReagentModal() {
        if (!reagentLotInput) initCombinedModalElements(); 

        const form = document.getElementById('reagent-form');
        if(form) form.reset(); 
        resetReagentScannerUIOnlyVisuals();

        selectedExistingReagent = null;
        if(reagentIdInput) reagentIdInput.value = '';
        if(reagentLotInput) reagentLotInput.value = '';
        if(expiryDateInput) expiryDateInput.value = '';
        if(rawScanInputEl) rawScanInputEl.value = '';
        if(reagentSearchNameInput) reagentSearchNameInput.value = '';
        if(selectedReagentNameInputEl) selectedReagentNameInputEl.value = '';
        if(modalAnalyzerSelect) modalAnalyzerSelect.value = '';
        if(scannedLotMatchesContainerEl) scannedLotMatchesContainerEl.innerHTML = '<p>Enter Lot # above or scan to see matches.</p>';
        if(suggestionsDropdownEl) {suggestionsDropdownEl.innerHTML = ''; suggestionsDropdownEl.classList.add('hidden');}

        // Clear receive stock fields
        if(receiveQuantityInput) receiveQuantityInput.value = '';
        if(receiveDateInput) receiveDateInput.value = '';
        if(receiveNotesInput) receiveNotesInput.value = '';
        if(receiveExistingUnitInput) receiveExistingUnitInput.value = '';
        if(receiveExistingCurrentStockInput) receiveExistingCurrentStockInput.value = '';
        if(receiveForReagentNameEl) receiveForReagentNameEl.textContent = '';

        // Clear register new fields
        if(registerNewNameInput) registerNewNameInput.value = '';
        if(registerNewInitialStockInput) registerNewInitialStockInput.value = '';
        if(registerNewUnitSelect) registerNewUnitSelect.value = '';
        if(registerNewDescInput) registerNewDescInput.value = '';
        if(registerNewStorageInput) registerNewStorageInput.value = '';
        if(registerNewNotesInput) registerNewNotesInput.value = '';

        currentModalIntent = 'idle'; 
        updateModalUIBasedOnState();
        openModal('reagent-modal');
    }
    function openModal(modalId) { 
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'flex'; 
    }

    function closeModal(modalId) {
        const modalToClose = document.getElementById(modalId);
        if (modalToClose) {
            modalToClose.style.display = 'none';
            if (modalId === 'reagent-modal') {
                stopReagentBarcodeScanner(); // Ensure camera is off
                // resetReagentScannerUIOnlyVisuals(); // Already called in openCombinedReagentModal, but good for explicit close
                const form = document.getElementById('reagent-form');
                if(form) form.reset(); // Clear all form fields
                
                // Reset state variables related to this modal
                selectedExistingReagent = null;
                if(reagentIdInput) reagentIdInput.value = '';
                if(reagentLotInput) {reagentLotInput.value = ''; reagentLotInput.readOnly = false;}
                if(expiryDateInput) {expiryDateInput.value = ''; expiryDateInput.readOnly = false;} 
                if(rawScanInputEl) rawScanInputEl.value = '';
                if(reagentSearchNameInput) reagentSearchNameInput.value = '';
                if(selectedReagentNameInputEl) selectedReagentNameInputEl.value = '';
                if(modalAnalyzerSelect) { modalAnalyzerSelect.value = ''; modalAnalyzerSelect.disabled = false;}
                if(scannedLotMatchesContainerEl) scannedLotMatchesContainerEl.innerHTML = '<p>Enter Lot # above or scan to see matches.</p>';
                if(suggestionsDropdownEl) {suggestionsDropdownEl.innerHTML = ''; suggestionsDropdownEl.classList.add('hidden');}

                if(receiveStockStageEl) receiveStockStageEl.classList.add('hidden');
                if(registerNewStageEl) registerNewStageEl.classList.add('hidden');
                if(toggleRegisterNewFieldsBtn) toggleRegisterNewFieldsBtn.classList.remove('hidden');
                currentModalIntent = 'idle';
                if(reagentFormSubmitBtn) reagentFormSubmitBtn.disabled = true; // Reset submit button state
            } else if (modalId === 'simple-reagent-edit-modal') {
                const form = document.getElementById('simple-reagent-edit-form');
                if (form) form.reset();
                if (simpleEditReagentIdInput) simpleEditReagentIdInput.value = '';
            } else if (modalId === 'consumption-modal') {
                 const form = document.getElementById('consumption-form');
                 if (form) form.reset();
                 const itemsContainer = document.getElementById('consumption-items-container');
                 if(itemsContainer) itemsContainer.innerHTML = ''; // Clear dynamic items
                 if(document.getElementById('consumption-edit-id')) document.getElementById('consumption-edit-id').value = '';
            }
        }
    }

    function closeAllModals() {
        document.querySelectorAll('.modal-backdrop').forEach(m => {
            if (m.id) closeModal(m.id); // Use specific close logic if available
            else m.style.display = 'none'; // Generic hide
        });
    }
    
 function validateCombinedModalForm() {
    const missingFields = getMissingFieldsCombinedModal();
    if (missingFields.length > 0) {
        showAlert(`Please ensure all required fields are correctly filled for the intended action. Missing/Invalid: ${missingFields.join(', ')}`, 'error', 7000);
        // highlightMissingFields(missingFields); // Implement if desired
        return false;
    }
    return true;
}

async function handleCombinedReagentFormSubmit(e) {
    e.preventDefault();
    
    if (!validateCombinedModalForm()) { // Validate first
        if(reagentFormSubmitBtn) reagentFormSubmitBtn.disabled = false; // Re-enable if validation fails early
        return;
    }

    if (!reagentLotInput || !expiryDateInput || !modalAnalyzerSelect || !reagentFormSubmitBtn) {
        showAlert('Critical form elements missing. Cannot submit.', 'error');
        return;
    }
    reagentFormSubmitBtn.disabled = true; 
    showLoading();

    try {
        const lotNumber = reagentLotInput.value.trim();
        const expiry = expiryDateInput.value;
        const analyzer = modalAnalyzerSelect.value;
        const todayIso = new Date().toISOString();

        if (currentModalIntent === 'receiving_selected' && selectedExistingReagent) {
            // ... (rest of receiving stock logic - largely unchanged from your good version) ...
            if (!receiveQuantityInput || !receiveDateInput || !receiveNotesInput) {
                showAlert('Receive stock form elements missing.', 'error'); throw new Error('Receive stock form elements missing.');
            }
            const quantityToAdd = parseFloat(receiveQuantityInput.value);
            const dateReceived = receiveDateInput.value;
            const notes = receiveNotesInput.value.trim();

            // Validation already done by validateCombinedModalForm, but double check criticals
            if (isNaN(quantityToAdd) || quantityToAdd <= 0 || !dateReceived) {
                showAlert('Please enter a valid quantity and date received to add stock.', 'error');
                throw new Error('Invalid quantity or date for receive stock.');
            }

            const newStockLevel = parseFloat(selectedExistingReagent.current_stock || 0) + quantityToAdd;
            const { error: updateError } = await supabase
                .from('reagents')
                .update({ current_stock: newStockLevel, updated_at: todayIso })
                .eq('id', selectedExistingReagent.id);
            if (updateError) throw new Error(`Failed to update reagent stock: ${updateError.message}`);

            const { error: logError } = await supabase
                .from('stock_receive_log')
                .insert({
                    reagent_id: selectedExistingReagent.id,
                    reagent_name: selectedExistingReagent.name,
                    lot_number: selectedExistingReagent.lot_number, // Use lot from the selected reagent instance
                    quantity_received: quantityToAdd,
                    unit: selectedExistingReagent.unit,
                    date_received: dateReceived,
                    notes: notes || `Stock added via modal to existing Lot: ${selectedExistingReagent.lot_number}`
                });
            if (logError) throw new Error(`Failed to log stock receipt: ${logError.message}`);
            showAlert(`Successfully added ${quantityToAdd} ${selectedExistingReagent.unit} to "${selectedExistingReagent.name}".`, 'success');

        } else if (currentModalIntent === 'registering_new') {
            // ... (rest of registering new logic - largely unchanged from your good version) ...
            if (!registerNewNameInput || !registerNewInitialStockInput || !registerNewUnitSelect) {
                 showAlert('Register new form elements missing.', 'error'); throw new Error('Register new form elements missing.');
            }
            const newReagentName = registerNewNameInput.value.trim();
            const initialStock = parseFloat(registerNewInitialStockInput.value);
            const unit = registerNewUnitSelect.value;
            const description = (registerNewDescInput ? registerNewDescInput.value.trim() : '');
            const storageConditions = (registerNewStorageInput ? registerNewStorageInput.value.trim() : '');
            const newReagentNotes = (registerNewNotesInput ? registerNewNotesInput.value.trim() : '');

             // Validation already done by validateCombinedModalForm, but double check criticals
            if (!newReagentName || !analyzer || !lotNumber || !expiry || isNaN(initialStock) || initialStock < 0 || !unit) {
                showAlert('Please fill all required fields for the new reagent correctly.', 'error');
                throw new Error('Required fields missing/invalid for new reagent.');
            }
            
            // Modified duplicate check: Allow same lot if other key fields differ.
            // An exact duplicate of Name, Lot, Expiry, Analyzer for a non-deleted item is still prevented.
            const existingDuplicate = reagentsCache.find(r => 
                !r.is_deleted &&
                r.name === newReagentName &&
                r.lot_number === lotNumber &&
                r.expiry_date === expiry && // Ensure date formats are comparable if one is from DB and one from input
                r.analyzer === analyzer
            );
            if (existingDuplicate) {
                showAlert(`A non-deleted reagent with the exact same Name, Lot, Expiry, and Analyzer already exists (ID: ${existingDuplicate.id}). Cannot register as new. If this is the same batch, consider adding stock to it. If it's a different item that happens to share these details, adjust one of them (e.g. slightly different name or description).`, 'error', 10000);
                throw new Error('Exact duplicate reagent found.');
            }

            const { data: newlyRegisteredReagent, error: insertError } = await supabase
                .from('reagents')
                .insert({
                    name: newReagentName, analyzer, lot_number: lotNumber, expiry_date: expiry,
                    current_stock: initialStock, unit, description, storage_conditions: storageConditions,
                    notes: newReagentNotes, created_at: todayIso, updated_at: todayIso 
                })
                .select()
                .single();
            if (insertError) throw new Error(`Failed to register new reagent: ${insertError.message}`);
            if (!newlyRegisteredReagent) throw new Error('Failed to get new reagent data after insert.');

            const { error: logError } = await supabase
                .from('stock_receive_log')
                .insert({
                    reagent_id: newlyRegisteredReagent.id, reagent_name: newReagentName, lot_number: lotNumber,
                    quantity_received: initialStock, unit, date_received: todayIso.split('T')[0],
                    notes: newReagentNotes || 'Initial stock upon registration'
                });
            if (logError) {
                console.error("Failed to log initial stock, reagent was created but log failed:", logError);
                showAlert(`New reagent "${newReagentName}" registered, but failed to log initial stock. Please check logs.`, 'warning', 6000);
            } else {
                showAlert(`New reagent "${newReagentName}" registered successfully with ${initialStock} ${unit}.`, 'success');
            }
        } else {
            showAlert('No clear action determined. Please check form and selections.', 'warning');
            throw new Error('Ambiguous modal state for submission.');
        }

        await loadAllData(); 
        updateDashboard();
        closeModal('reagent-modal');

    } catch (error) {
        console.error("Error in handleCombinedReagentFormSubmit:", error);
        showAlert(`Operation failed: ${error.message}`, 'error', 7000);
    } finally {
        hideLoading();
        if(reagentFormSubmitBtn) reagentFormSubmitBtn.disabled = false;
        // updateModalUIBasedOnState(); // Re-evaluate button state if modal didn't close
    }
}




    function getMissingFieldsCombinedModal() {
    const missing = [];
    if (currentModalIntent === 'registering_new') {
        if (!registerNewNameInput || !registerNewNameInput.value.trim()) missing.push("Reagent Name (for new)");
        if (!modalAnalyzerSelect || !modalAnalyzerSelect.value) missing.push("Analyzer");
        if (!reagentLotInput || !reagentLotInput.value.trim()) missing.push("Lot Number");
        if (!expiryDateInput || !expiryDateInput.value) missing.push("Expiry Date");
        if (!registerNewInitialStockInput || !registerNewInitialStockInput.value || parseFloat(registerNewInitialStockInput.value) < 0) missing.push("Initial Stock (>=0)");
        if (!registerNewUnitSelect || !registerNewUnitSelect.value) missing.push("Unit (for new)");
    } else if (currentModalIntent === 'receiving_selected') {
        if (!selectedExistingReagent) missing.push("A specific reagent to receive stock for (select from matches or search)");
        if (!receiveQuantityInput || !receiveQuantityInput.value || parseFloat(receiveQuantityInput.value) <= 0) missing.push("Quantity to Add (>0)");
        if (!receiveDateInput || !receiveDateInput.value) missing.push("Date Received");
    } else {
        missing.push("A clear action (Register New or Receive for Selected Existing Reagent)");
    }
    return missing;
}
function validateCombinedModalForm() {
    const missingFields = getMissingFieldsCombinedModal();
    if (missingFields.length > 0) {
        showAlert(`Please ensure all required fields are correctly filled for the intended action. Missing/Invalid: ${missingFields.join(', ')}`, 'error', 7000);
        // highlightMissingFields(missingFields); // Implement if desired
        return false;
    }
    return true;
}

    // --- Simple Reagent Edit Modal Functions ---
    function openSimpleReagentEditModal(reagentId) {
        const reagent = reagentsCache.find(r => r.id === reagentId && !r.is_deleted);
        if (!reagent) {
            showAlert('Reagent not found or is deleted.', 'error');
            return;
        }

        if (!simpleEditReagentIdInput || !simpleEditReagentNameInput || !simpleEditAnalyzerSelect || !simpleEditDescInput || !simpleEditStorageInput || !simpleEditNotesInput) {
            showAlert('Simple edit modal elements not found.', 'error');
            return;
        }
        
        // Populate analyzer dropdown for this modal (could also be done once at init)
        populateAnalyzerDropdown(simpleEditAnalyzerSelect, false);


        simpleEditReagentIdInput.value = reagent.id;
        simpleEditReagentNameInput.value = reagent.name;
        simpleEditAnalyzerSelect.value = reagent.analyzer;
        simpleEditDescInput.value = reagent.description || '';
        simpleEditStorageInput.value = reagent.storage_conditions || '';
        simpleEditNotesInput.value = reagent.notes || '';
        
        document.getElementById('simple-reagent-edit-modal-title').textContent = `Edit Info: ${reagent.name} (Lot: ${reagent.lot_number})`;
        openModal('simple-reagent-edit-modal');
    }

    async function handleSimpleReagentEditFormSubmit(e) {
        e.preventDefault();
        showLoading();

        if (!simpleEditReagentIdInput || !simpleEditReagentNameInput || !simpleEditAnalyzerSelect || !simpleEditDescInput || !simpleEditStorageInput || !simpleEditNotesInput) {
            showAlert('Simple edit modal form elements missing.', 'error'); hideLoading(); return;
        }

        const reagentId = simpleEditReagentIdInput.value;
        const updatedData = {
            name: simpleEditReagentNameInput.value.trim(),
            analyzer: simpleEditAnalyzerSelect.value,
            description: simpleEditDescInput.value.trim(),
            storage_conditions: simpleEditStorageInput.value.trim(),
            notes: simpleEditNotesInput.value.trim(),
            updated_at: new Date().toISOString()
        };

        if (!updatedData.name || !updatedData.analyzer) {
            showAlert('Reagent Name and Analyzer are required.', 'error');
            hideLoading(); return;
        }

        try {
            const { error } = await supabase
                .from('reagents')
                .update(updatedData)
                .eq('id', reagentId);

            if (error) throw error;

            showAlert('Reagent information updated successfully.', 'success');
            await loadAllData(); // Refresh data
            closeModal('simple-reagent-edit-modal');
        } catch (error) {
            console.error('Error updating reagent (simple edit):', error);
            showAlert(`Failed to update reagent: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }


    // --- Old/Separate Consumption Modal Functions ---
    function openConsumptionModal(consumptionIdToEdit = null) {
        const form = document.getElementById('consumption-form');
        if(!form) return;
        form.reset();
        
        const editIdField = document.getElementById('consumption-edit-id');
        if(editIdField) editIdField.value = '';
        
        const itemsContainer = document.getElementById('consumption-items-container');
        if(itemsContainer) itemsContainer.innerHTML = '';
        
        const addBtn = document.getElementById('add-consumption-item-btn');
        if(addBtn) addBtn.classList.remove('hidden');
        
        const modalTitleEl = document.getElementById('consumption-modal-title');
        const batchDateEl = document.getElementById('consumption-batch-date');
        const batchNotesEl = document.getElementById('consumption-batch-notes');


        if (consumptionIdToEdit) {
            const record = consumptionCache.find(c => c.id === consumptionIdToEdit && !c.is_deleted);
            if (!record) {
                showAlert('Consumption record not found or already deleted.', 'error');
                return;
            }
            if(modalTitleEl) modalTitleEl.textContent = 'Edit Consumption Record';
            if(editIdField) editIdField.value = record.id;
            addConsumptionItemRow(record.reagent_id, record.quantity, record.notes); // Pass individual item notes
            if(batchDateEl) batchDateEl.value = record.date;
            if(batchNotesEl) batchNotesEl.value = record.overall_notes || ''; // Populate overall notes
            if(addBtn) addBtn.classList.add('hidden'); // Hide "add another" button in edit mode
        } else {
            if(modalTitleEl) modalTitleEl.textContent = 'Record Consumption (Batch)';
            addConsumptionItemRow(); // Add one empty item row
            if(batchDateEl) batchDateEl.valueAsDate = new Date(); // Default to today
        }
        openModal('consumption-modal');
    }
   
   
  function addConsumptionItemRow(reagentIdVal = '', quantityVal = '', itemNotesVal = '') {
    const itemsContainer = document.getElementById('consumption-items-container');
    if(!itemsContainer) return;

    const itemDiv = document.createElement('div');
    itemDiv.classList.add('consumption-item');
    const pseudoItemId = `item-${Math.random().toString(36).substring(2, 9)}`;

    // HTML structure for dynamic search input
    itemDiv.innerHTML = `
        <div class="row">
            <div class="col">
                <div class="form-group form-group-relative">
                    <label for="consumption-reagent-search-${pseudoItemId}">Reagent* (Name/Lot)</label>
                    <input type="text" id="consumption-reagent-search-${pseudoItemId}" class="consumption-reagent-search-input" placeholder="Type to search available reagents..." autocomplete="off">
                    <input type="hidden" id="consumption-reagent-id-${pseudoItemId}" class="consumption-reagent-id-input" value="${reagentIdVal}">
                    <div id="consumption-reagent-suggestions-${pseudoItemId}" class="suggestions-dropdown hidden"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col"><div class="form-group">
                <label for="consumption-quantity-${pseudoItemId}">Quantity*</label>
                <input type="number" id="consumption-quantity-${pseudoItemId}" class="consumption-quantity-input" min="0.01" step="0.01" value="${quantityVal}" required>
            </div></div>
            <div class="col"><div class="form-group">
                <label for="consumption-unit-${pseudoItemId}">Unit</label>
                <input type="text" id="consumption-unit-${pseudoItemId}" class="consumption-unit-input" readonly>
            </div></div>
        </div>
         <div class="form-group item-notes">
            <label for="consumption-item-notes-${pseudoItemId}">Item Notes (Optional)</label>
            <textarea id="consumption-item-notes-${pseudoItemId}" rows="1">${itemNotesVal}</textarea>
        </div>
        <button type="button" class="btn-warning remove-consumption-item-btn" style="font-size:12px; padding: 4px 8px;">Remove</button>
    `;
    itemsContainer.appendChild(itemDiv);

    const searchInput = itemDiv.querySelector(`#consumption-reagent-search-${pseudoItemId}`);
    const idInput = itemDiv.querySelector(`#consumption-reagent-id-${pseudoItemId}`);
    const suggestionsEl = itemDiv.querySelector(`#consumption-reagent-suggestions-${pseudoItemId}`);
    const unitInput = itemDiv.querySelector(`#consumption-unit-${pseudoItemId}`);
    const quantityInput = itemDiv.querySelector(`#consumption-quantity-${pseudoItemId}`); // For max attribute
    const removeItemBtn = itemDiv.querySelector('.remove-consumption-item-btn');

    // If editing and reagentIdVal is provided, pre-fill search text and unit
    if (reagentIdVal) {
        const reagent = reagentsCache.find(r => r.id.toString() === reagentIdVal.toString());
        if (reagent) {
            searchInput.value = `${reagent.name} - Lot: ${reagent.lot_number || 'N/A'}`;
            unitInput.value = reagent.unit;
            if (!reagent.is_deleted) quantityInput.max = reagent.current_stock; // Set max based on current stock
        }
    }

    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        suggestionsEl.innerHTML = '';
        suggestionsEl.classList.add('hidden');
        idInput.value = ''; // Clear hidden ID when user types
        unitInput.value = ''; // Clear unit
        quantityInput.max = ''; // Clear max stock constraint

        if (searchTerm.length < 1 && !reagentIdVal) return; // Don't search on empty if not pre-filled

        // Filter for non-deleted reagents with stock > 0 for NEW consumption.
        // For EDITING, allow selection of original (even if now 0 stock/deleted) but prefer active.
        const isEditMode = document.getElementById('consumption-edit-id') && document.getElementById('consumption-edit-id').value;
        
        const filteredReagents = reagentsCache.filter(r => {
            const nameMatch = r.name.toLowerCase().includes(searchTerm);
            const lotMatch = r.lot_number && r.lot_number.toLowerCase().includes(searchTerm);
            const matchesSearch = nameMatch || lotMatch;

            if (isEditMode) return matchesSearch; // Show all matches in edit mode
            return !r.is_deleted && r.current_stock > 0 && matchesSearch; // Stricter for new consumption
        }).slice(0, 10); // Limit suggestions

        if (filteredReagents.length > 0) {
            filteredReagents.forEach(r => {
                const div = document.createElement('div');
                let displayText = `${r.name} (Lot: ${r.lot_number || 'N/A'})`;
                if (!r.is_deleted) {
                    displayText += ` - Stock: ${r.current_stock} ${r.unit}`;
                } else {
                    displayText += ` [DELETED]`;
                }
                if (r.current_stock <= 0 && !r.is_deleted && !isEditMode) {
                     displayText += ` [NO STOCK]`;
                }

                div.textContent = displayText;
                div.dataset.reagentId = r.id;
                div.dataset.unit = r.unit;
                div.dataset.currentStock = r.current_stock;
                div.dataset.isDeleted = r.is_deleted;
                div.dataset.searchText = `${r.name} - Lot: ${r.lot_number || 'N/A'}`;


                div.addEventListener('click', () => {
                    searchInput.value = div.dataset.searchText;
                    idInput.value = div.dataset.reagentId;
                    unitInput.value = div.dataset.unit;
                    if (div.dataset.isDeleted === "false") { // Max only for non-deleted
                        quantityInput.max = div.dataset.currentStock;
                    } else {
                        quantityInput.removeAttribute('max');
                    }
                    suggestionsEl.classList.add('hidden');
                    // Optionally, focus quantity input: quantityInput.focus();
                });
                suggestionsEl.appendChild(div);
            });
            suggestionsEl.classList.remove('hidden');
        }
    });
    
    // Hide suggestions on outside click for this specific search input
    document.addEventListener('click', (e) => {
        if (suggestionsEl && searchInput && !searchInput.contains(e.target) && !suggestionsEl.contains(e.target)) {
            suggestionsEl.classList.add('hidden');
        }
    });

    if(removeItemBtn) {
        removeItemBtn.addEventListener('click', () => itemDiv.remove());
        const isEditMode = document.getElementById('consumption-edit-id') && document.getElementById('consumption-edit-id').value;
        if ((itemsContainer.children.length === 1 && !isEditMode) || isEditMode) {
            removeItemBtn.classList.add('hidden'); // Hide if only item (new) or if editing (only one item allowed)
        }
    }
}

   
async function handleConsumptionFormSubmit(e) {
    e.preventDefault();
    showLoading();

    const consumptionEditId = document.getElementById('consumption-edit-id').value;
    const consumptionDate = document.getElementById('consumption-batch-date').value;
    const overallNotes = document.getElementById('consumption-batch-notes').value.trim();

    const consumptionItemsData = [];
    const itemRows = document.querySelectorAll('#consumption-items-container .consumption-item');

    if (itemRows.length === 0) {
        showAlert('Please add at least one reagent to consume.', 'error');
        hideLoading(); return;
    }

    let isValid = true;
    let validationMessages = [];

    for (const row of itemRows) {
        const reagentId = row.querySelector('.consumption-reagent-id-input').value; // Using hidden ID field
        const searchInputValue = row.querySelector('.consumption-reagent-search-input').value; // For display name in error
        const quantity = parseFloat(row.querySelector('.consumption-quantity-input').value);
        const unit = row.querySelector('.consumption-unit-input').value; // Should be auto-filled
        const itemNotesVal = row.querySelector('textarea[id^="consumption-item-notes-"]').value.trim();

        if (!reagentId) {
            validationMessages.push(`A reagent must be selected for item: "${searchInputValue || 'Untitled Item'}"`);
            isValid = false; continue;
        }
        if (isNaN(quantity) || quantity <= 0) {
            validationMessages.push(`Quantity for reagent "${searchInputValue}" must be a positive number.`);
            isValid = false; continue;
        }
        
        const reagent = reagentsCache.find(r => r.id.toString() === reagentId.toString());
        if (!reagent) {
            validationMessages.push(`Selected reagent "${searchInputValue}" not found in cache. Please re-select.`);
            isValid = false; continue;
        }

        if (!consumptionEditId) { // Checks for new consumption
            if (reagent.is_deleted) {
                validationMessages.push(`Cannot consume from a deleted reagent: ${reagent.name}.`);
                isValid = false; continue;
            }
            if (quantity > parseFloat(reagent.current_stock)) {
                validationMessages.push(`Not enough stock for ${reagent.name} (Lot: ${reagent.lot_number || 'N/A'}). Requested: ${quantity}, Available: ${reagent.current_stock}`);
                isValid = false; continue;
            }
        }
        consumptionItemsData.push({ reagentId, quantity, unit, reagent, itemNotes: itemNotesVal, searchInputValue });
    }

    if (!isValid || !consumptionDate) {
        if (!consumptionDate) validationMessages.push("A consumption date must be selected.");
        showAlert(`Please correct the following: ${validationMessages.join('; ')}`, 'error', 7000);
        hideLoading(); return;
    }

    try {
        if (consumptionEditId) {
            // ... (Edit logic from your previous good version, ensuring reagentId is from consumptionItemsData[0].reagentId)
            if (consumptionItemsData.length !== 1) {
                showAlert('Edit mode error: Expected one consumption item.', 'error'); throw new Error('Edit mode error');
            }
            const originalRecord = consumptionCache.find(c => c.id.toString() === consumptionEditId.toString());
            if (!originalRecord) { showAlert('Original consumption record not found.', 'error'); throw new Error('Original record not found'); }
            
            const editedItem = consumptionItemsData[0];
            const originalReagent = reagentsCache.find(r => r.id.toString() === originalRecord.reagent_id.toString());
            const newReagentForEdit = editedItem.reagent;

            let stockAdjustmentPromises = [];

            if (originalReagent && !originalReagent.is_deleted) {
                stockAdjustmentPromises.push(
                    supabase.from('reagents')
                    .update({ current_stock: parseFloat(originalReagent.current_stock) + parseFloat(originalRecord.quantity) })
                    .eq('id', originalReagent.id)
                );
            }
            await Promise.all(stockAdjustmentPromises);

            if (newReagentForEdit.is_deleted) {
                 showAlert(`Cannot consume from a deleted reagent: ${newReagentForEdit.name}.`, 'error'); throw new Error('Target reagent deleted for edit');
            }
            const { data: newReagentCurrentData, error: fetchError } = await supabase.from('reagents').select('current_stock').eq('id', newReagentForEdit.id).single();
            if(fetchError || !newReagentCurrentData) {
                showAlert(`Could not fetch current stock for ${newReagentForEdit.name}. Aborting edit.`, 'error'); throw new Error('Stock fetch error');
            }
            const currentStockOfNewReagent = parseFloat(newReagentCurrentData.current_stock);

            if (currentStockOfNewReagent < editedItem.quantity) {
                showAlert(`Not enough stock for ${newReagentForEdit.name} (Lot: ${newReagentForEdit.lot_number}). Requested: ${editedItem.quantity}, Available: ${currentStockOfNewReagent}. Stock changes reverted.`, 'error');
                if (originalReagent && !originalReagent.is_deleted) {
                   await supabase.from('reagents') // Revert the reversion
                       .update({ current_stock: parseFloat(originalReagent.current_stock) })
                       .eq('id', originalReagent.id);
                }
                throw new Error('Insufficient stock for edit');
            }
            
            await supabase.from('reagents')
                .update({ current_stock: currentStockOfNewReagent - parseFloat(editedItem.quantity), updated_at: new Date().toISOString() })
                .eq('id', newReagentForEdit.id);

            const { error: updateLogError } = await supabase.from('consumption_log')
                .update({ 
                    date: consumptionDate, reagent_id: editedItem.reagentId, quantity: editedItem.quantity, 
                    unit: editedItem.unit, notes: editedItem.itemNotes, overall_notes: overallNotes, 
                    updated_at: new Date().toISOString()
                })
                .eq('id', consumptionEditId);
            if (updateLogError) throw updateLogError;
            showAlert('Consumption record updated successfully.', 'success');

        } else { // Adding new
            // ... (Add new logic from your previous good version, ensuring reagentId is from item.reagentId)
            let allSuccessful = true;
            for (const item of consumptionItemsData) {
                const newStock = parseFloat(item.reagent.current_stock) - parseFloat(item.quantity);
                const { error: reagentUpdateError } = await supabase.from('reagents').update({ current_stock: newStock, updated_at: new Date().toISOString() }).eq('id', item.reagentId);
                
                if (reagentUpdateError) { 
                    showAlert(`Error updating stock for ${item.searchInputValue}: ${reagentUpdateError.message}`, 'error'); 
                    allSuccessful = false; continue; 
                }

                const consumptionData = { 
                    reagent_id: item.reagentId, date: consumptionDate, quantity: item.quantity, 
                    unit: item.unit, notes: item.itemNotes, overall_notes: overallNotes 
                };
                const { error: consumptionInsertError } = await supabase.from('consumption_log').insert(consumptionData);
                if (consumptionInsertError) { 
                    showAlert(`Error logging consumption for ${item.searchInputValue}: ${consumptionInsertError.message}`, 'error'); 
                    allSuccessful = false; 
                    await supabase.from('reagents').update({ current_stock: item.reagent.current_stock, updated_at: new Date().toISOString() }).eq('id', item.reagentId); // Revert
                }
            }
            if (allSuccessful && consumptionItemsData.length > 0) showAlert('Consumption(s) recorded successfully.', 'success');
            else if (consumptionItemsData.length > 0) showAlert('Some consumptions recorded with errors. Please check logs and stock levels.', 'warning');
        }
        
        await loadAllData(); 
        closeAllModals();

    } catch (error) {
        console.error("Error in handleConsumptionFormSubmit:", error);
        showAlert(`Operation failed: ${error.message}. Stock might be inconsistent if error occurred mid-process.`, 'error', 7000);
    } finally {
        hideLoading();
    }
}


    // --- Deletion Logic ---
    function showDeleteConfirmation(idOrIds, type, permanent = false) {
        deleteTarget = { id: null, ids: null, type, permanent };
        if (Array.isArray(idOrIds)) deleteTarget.ids = idOrIds;
        else deleteTarget.id = idOrIds;

        const modal = document.getElementById('delete-confirm-modal');
        const messageEl = document.getElementById('delete-confirm-message');
        const confirmBtn = document.getElementById('confirm-delete-btn');

        if (!modal || !messageEl || !confirmBtn) {
            console.error("Delete confirmation modal elements not found."); return;
        }
        
        let itemTypeDisplay = type.replace(/([A-Z])/g, ' $1').toLowerCase()
                                .replace('-restore', '').replace('-bulk-soft-delete', '')
                                .replace('stock log', 'stock receive log'); // more user friendly

        const count = deleteTarget.ids ? deleteTarget.ids.length : (deleteTarget.id ? 1 : 0);
        const plural = count > 1 ? 's' : '';


        if (permanent) {
            messageEl.textContent = `Are you sure you want to PERMANENTLY delete ${count} ${itemTypeDisplay} record${plural}? This action CANNOT be undone.`;
            confirmBtn.textContent = 'Permanently Delete'; confirmBtn.className = 'btn-warning'; // Changed to warning as it's destructive
        } else if (type.endsWith('-restore')) {
             messageEl.textContent = `Are you sure you want to restore ${count} ${itemTypeDisplay} record${plural}?`;
             confirmBtn.textContent = 'Restore'; confirmBtn.className = 'btn-accent';
        } else { // Soft delete
            messageEl.textContent = `Are you sure you want to delete ${count} ${itemTypeDisplay} record${plural}? ${count > 1 ? 'They' : 'It'} can be recovered later.`;
            confirmBtn.textContent = type.includes('bulk') ? `Soft Delete ${count} Item${plural}` : 'Soft Delete'; confirmBtn.className = 'btn-danger'; // Changed to danger for soft delete
        }
        openModal('delete-confirm-modal');
    }
    async function handleConfirmDelete() {
        if ((!deleteTarget.id && (!deleteTarget.ids || deleteTarget.ids.length === 0)) || !deleteTarget.type) {
            showAlert('No target selected for deletion.', 'info'); return;
        }
        showLoading();
        let overallSuccess = true; let SerrorMessages = [];
        const itemsToProcess = deleteTarget.ids ? deleteTarget.ids : [deleteTarget.id];
        const operationBaseType = deleteTarget.type.replace('-bulk-soft-delete', '').replace('-restore', '');
        const isRestore = deleteTarget.type.endsWith('-restore');

        for (const itemId of itemsToProcess) {
            let tableName, currentItem, reagentToUpdate;
            try {
                switch (operationBaseType) {
                    case 'reagent': 
                        tableName = 'reagents'; 
                        currentItem = reagentsCache.find(i => i.id.toString() === itemId.toString()); 
                        if (currentItem && currentItem.current_stock > 0 && !isRestore && !deleteTarget.permanent) {
                           SerrorMessages.push(`Reagent "${currentItem.name}" (Lot: ${currentItem.lot_number}) has stock (${currentItem.current_stock} ${currentItem.unit}). Cannot soft delete directly. Consume stock first or use permanent delete if intended.`);
                           overallSuccess = false; continue; // Skip this item
                        }
                        break;
                    case 'consumption': 
                        tableName = 'consumption_log'; 
                        currentItem = consumptionCache.find(i => i.id.toString() === itemId.toString());
                        if (currentItem) reagentToUpdate = reagentsCache.find(r => r.id.toString() === currentItem.reagent_id.toString() && !r.is_deleted);
                        break;
                    case 'stockLog': 
                        tableName = 'stock_receive_log'; 
                        currentItem = stockLogCache.find(i => i.id.toString() === itemId.toString());
                        if (currentItem) reagentToUpdate = reagentsCache.find(r => r.id.toString() === currentItem.reagent_id.toString() && !r.is_deleted);
                        break;
                    default: 
                        SerrorMessages.push('Unknown item type for deletion.'); overallSuccess = false; continue;
                }

                if (!currentItem) { SerrorMessages.push(`Item ID ${itemId} not found for type ${operationBaseType}.`); overallSuccess = false; continue; }

                if (deleteTarget.permanent) {
                    const { error } = await supabase.from(tableName).delete().eq('id', itemId);
                    if (error) { SerrorMessages.push(`Error permanently deleting ${currentItem.name || `ID ${itemId}`}: ${error.message}`); overallSuccess = false; }
                } else { // Soft delete / restore
                    const newDeletedState = !isRestore;
                    const updateData = { is_deleted: newDeletedState, deleted_at: newDeletedState ? new Date().toISOString() : null };
                    if (tableName !== 'stock_receive_log') updateData.updated_at = new Date().toISOString(); // Stock log might not have updated_at
                    
                    // Handle stock adjustments
                    let stockAdjustError = null;
                    if (reagentToUpdate) { // For consumption and stockLog
                        let stockChange = 0;
                        if (operationBaseType === 'consumption') stockChange = isRestore ? -currentItem.quantity : currentItem.quantity;
                        else if (operationBaseType === 'stockLog') stockChange = isRestore ? currentItem.quantity_received : -currentItem.quantity_received;

                        const newReagentStock = parseFloat(reagentToUpdate.current_stock) + stockChange;
                        if (newReagentStock < 0 && !isRestore) { // If deleting (consumption or stockLog) would make stock negative
                             showAlert(`Warning: Operation on ${reagentToUpdate.name} (Lot: ${reagentToUpdate.lot_number}) would result in negative stock. Stock will be set to 0.`, 'warning', 5000);
                             const { error: stockErr } = await supabase.from('reagents').update({ current_stock: 0 }).eq('id', reagentToUpdate.id);
                             if (stockErr) stockAdjustError = `Failed to set stock to 0 for ${reagentToUpdate.name}: ${stockErr.message}`;
                        } else {
                            const { error: stockErr } = await supabase.from('reagents').update({ current_stock: newReagentStock }).eq('id', reagentToUpdate.id);
                            if (stockErr) stockAdjustError = `Failed to adjust stock for ${reagentToUpdate.name}: ${stockErr.message}`;
                        }
                    } else if (isRestore && (operationBaseType === 'consumption' || operationBaseType === 'stockLog')) {
                        stockAdjustError = `Cannot restore ${currentItem.reagent_name || `item ID ${itemId}`}: Associated reagent not found or is deleted. Record will be marked restored, but stock not adjusted.`;
                    }
                    if (stockAdjustError) { SerrorMessages.push(stockAdjustError); overallSuccess = false; /* continue; // Decide if to proceed with marking as deleted/restored despite stock error */ }
                    
                    // Proceed with marking the log item as deleted/restored
                    const { error } = await supabase.from(tableName).update(updateData).eq('id', itemId);
                    if (error) { SerrorMessages.push(`Error updating record ${currentItem.name || `ID ${itemId}`}: ${error.message}. Stock might be inconsistent.`); overallSuccess = false; }
                }
            } catch (err) {
                SerrorMessages.push(`Unexpected error processing item ID ${itemId}: ${err.message}`);
                overallSuccess = false;
            }
        } // end for loop

        if (SerrorMessages.length > 0) {
            showAlert(`Operation completed with errors: ${SerrorMessages.join('; ')}`, 'error', 10000);
        } else if (overallSuccess) {
             showAlert(`${itemsToProcess.length} item(s) ${deleteTarget.permanent ? 'permanently deleted' : (isRestore ? 'restored' : 'soft deleted')} successfully.`, 'success');
        } else {
             showAlert('Operation partially failed. Check messages and console.', 'warning', 7000);
        }
        
        await loadAllData(); 
        closeAllModals();
        deleteTarget = { id: null, ids: null, type: null, permanent: false }; // Reset
        hideLoading();
    }


    // --- Table Population & Rendering ---
    function getFilteredReagents() { return reagentsCache.filter(r => showDeletedReagents ? true : !r.is_deleted); }
    function getFilteredConsumption() { return consumptionCache.filter(c => showDeletedConsumption ? true : !c.is_deleted); }
    function getFilteredStockLogs() { return stockLogCache.filter(sl => showDeletedStockLog ? true : !sl.is_deleted); }
    
    function populateReagentsTable(reagentsToDisplay = null) {
        const tableBody = document.getElementById('reagents-table-body');
        if(!tableBody) return;
        tableBody.innerHTML = '';
        const reagents = reagentsToDisplay || getFilteredReagents().filter(filterReagentLogic);
        const today = moment().startOf('day');
        const thirtyDaysFromNow = moment().add(30, 'days').endOf('day');

        if (reagents.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">No reagents found matching criteria.</td></tr>`;
            return;
        }
        reagents.forEach(reagent => {
            const row = document.createElement('tr');
            if (reagent.is_deleted) row.style.backgroundColor = '#ffebee'; // Light red for deleted
            
            let status = 'OK'; let statusClass = 'badge-success';
            const expiryDateMoment = moment(reagent.expiry_date);
            if (expiryDateMoment.isBefore(today)) { status = 'Expired'; statusClass = 'badge-danger'; }
            else if (expiryDateMoment.isBetween(today, thirtyDaysFromNow, undefined, '[]')) { status = 'Expiring Soon'; statusClass = 'badge-warning'; }
            
            row.innerHTML = `
                <td><input type="checkbox" class="reagent-row-checkbox" data-id="${reagent.id}" ${reagent.is_deleted ? 'disabled' : ''}></td>
                <td>${reagent.name} ${reagent.is_deleted ? '<span class="badge badge-danger" style="font-size:10px;">Deleted</span>': ''}</td>
                <td>${reagent.lot_number || '-'}</td>
                <td>${reagent.analyzer}</td>
                <td>${reagent.current_stock}</td>
                <td>${reagent.unit}</td>
                <td>${formatDate(reagent.expiry_date)}</td>
                <td><span class="badge ${statusClass}">${status}</span></td>
                <td class="actions">
                    ${reagent.is_deleted ? `
                        <button class="btn-accent btn-restore" data-id="${reagent.id}" title="Restore this reagent">Restore</button>
                        <button class="btn-warning btn-perm-delete" data-id="${reagent.id}" title="Permanently delete this reagent">Delete Perm.</button>
                    ` : `
                        <button class="btn-secondary btn-edit-reagent-info" data-id="${reagent.id}" title="Edit non-stock information">Edit Info</button>
                        <button class="btn-danger btn-delete-reagent" data-id="${reagent.id}" title="Soft delete this reagent">Delete</button>
                    `}
                </td>
            `;
            if (reagent.is_deleted) {
                const restoreBtn = row.querySelector('.btn-restore');
                const permDeleteBtn = row.querySelector('.btn-perm-delete');
                if(restoreBtn) restoreBtn.addEventListener('click', () => showDeleteConfirmation(reagent.id, 'reagent-restore'));
                if(permDeleteBtn) permDeleteBtn.addEventListener('click', () => showDeleteConfirmation(reagent.id, 'reagent', true));
            } else {
                const editInfoBtn = row.querySelector('.btn-edit-reagent-info');
                const deleteBtn = row.querySelector('.btn-delete-reagent');
                if(editInfoBtn) editInfoBtn.addEventListener('click', () => openSimpleReagentEditModal(reagent.id));
                if(deleteBtn) deleteBtn.addEventListener('click', () => showDeleteConfirmation(reagent.id, 'reagent'));
            }
            tableBody.appendChild(row);
        });
        updateReagentBulkActionVisibility();
    }

    function populateConsumptionTable(consumptionToDisplay = null) {
        const tableBody = document.getElementById('consumption-table-body');
        if(!tableBody) return;
        tableBody.innerHTML = '';
        const consumptionData = consumptionToDisplay || getFilteredConsumption().filter(filterConsumptionLogic);

        if (consumptionData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No consumption records found.</td></tr>`;
            return;
        }
        consumptionData.forEach(record => {
            const row = document.createElement('tr');
            if (record.is_deleted) row.style.backgroundColor = '#ffebee';
            const reagent = reagentsCache.find(r => r.id.toString() === record.reagent_id.toString()); // Match ID as string or number
            
            row.innerHTML = `
                <td>${formatDate(record.date)} ${record.is_deleted ? '<span class="badge badge-danger" style="font-size:10px;">Deleted</span>': ''}</td>
                <td>${reagent ? reagent.name : `Unknown/Deleted (ID: ${record.reagent_id})`}</td>
                <td>${reagent ? (reagent.lot_number || '-') : '-'}</td>
                <td>${record.quantity}</td>
                <td>${record.unit}</td>
                <td>${(record.notes || '')}${record.notes && record.overall_notes ? '; ' : ''}${(record.overall_notes || '') || '-'}</td>
                <td class="actions">
                     ${record.is_deleted ? `
                        <button class="btn-accent btn-restore" data-id="${record.id}">Restore</button>
                        <button class="btn-warning btn-perm-delete" data-id="${record.id}">Delete Perm.</button>
                    ` : `
                        <button class="btn-secondary btn-edit-consumption" data-id="${record.id}">Edit</button>
                        <button class="btn-danger btn-delete-consumption" data-id="${record.id}">Delete</button>
                    `}
                </td>
            `;
             if (record.is_deleted) {
                const restoreBtn = row.querySelector('.btn-restore');
                const permDeleteBtn = row.querySelector('.btn-perm-delete');
                if(restoreBtn) restoreBtn.addEventListener('click', () => showDeleteConfirmation(record.id, 'consumption-restore'));
                if(permDeleteBtn) permDeleteBtn.addEventListener('click', () => showDeleteConfirmation(record.id, 'consumption', true));
            } else {
                const editBtn = row.querySelector('.btn-edit-consumption');
                const deleteBtn = row.querySelector('.btn-delete-consumption');
                if(editBtn) editBtn.addEventListener('click', () => openConsumptionModal(record.id));
                if(deleteBtn) deleteBtn.addEventListener('click', () => showDeleteConfirmation(record.id, 'consumption'));
            }
            tableBody.appendChild(row);
        });
    }
    function populateStockLogTable(logsToDisplay = null) {
        const tableBody = document.getElementById('stock-log-table-body');
        if(!tableBody) return;
        tableBody.innerHTML = '';
        const logs = logsToDisplay || getFilteredStockLogs().filter(filterStockLogLogic);

        if (logs.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No stock receive records found.</td></tr>`;
            return;
        }
        logs.forEach(log => {
            const row = document.createElement('tr');
             if (log.is_deleted) row.style.backgroundColor = '#ffebee';
            row.innerHTML = `
                <td>${formatDate(log.date_received)} ${log.is_deleted ? '<span class="badge badge-danger" style="font-size:10px;">Deleted</span>': ''}</td>
                <td>${log.reagent_name || 'N/A'}</td>
                <td>${log.lot_number || 'N/A'}</td>
                <td>${log.quantity_received}</td>
                <td>${log.unit}</td>
                <td>${log.notes || '-'}</td>
                <td>${formatDate(log.created_at, 'YYYY-MM-DD HH:mm')}</td>
                <td class="actions">
                    ${log.is_deleted ? `
                        <button class="btn-accent btn-restore" data-id="${log.id}">Restore</button>
                        <button class="btn-warning btn-perm-delete" data-id="${log.id}">Delete Perm.</button>
                    ` : `
                        <button class="btn-danger btn-delete-stocklog" data-id="${log.id}">Delete</button>
                    `}
                </td>
            `;
             if (log.is_deleted) {
                const restoreBtn = row.querySelector('.btn-restore');
                const permDeleteBtn = row.querySelector('.btn-perm-delete');
                if(restoreBtn) restoreBtn.addEventListener('click', () => showDeleteConfirmation(log.id, 'stockLog-restore'));
                if(permDeleteBtn) permDeleteBtn.addEventListener('click', () => showDeleteConfirmation(log.id, 'stockLog', true));
            } else {
                const deleteBtn = row.querySelector('.btn-delete-stocklog');
                if(deleteBtn) deleteBtn.addEventListener('click', () => showDeleteConfirmation(log.id, 'stockLog'));
            }
            tableBody.appendChild(row);
        });
    }
    function updateDashboard() {
        const activeReagents = reagentsCache.filter(r => !r.is_deleted);
        const today = moment().startOf('day');
        const thirtyDaysFromNow = moment().add(30, 'days').endOf('day');
        
        const totalReagentsValEl = document.getElementById('total-reagents-val');
        const expiringSoonValEl = document.getElementById('expiring-soon-val');
        const expiredValEl = document.getElementById('expired-val');

        if(totalReagentsValEl) totalReagentsValEl.textContent = activeReagents.length;
        if(expiringSoonValEl) expiringSoonValEl.textContent = activeReagents.filter(r => moment(r.expiry_date).isBetween(today, thirtyDaysFromNow, undefined, '[]')).length;
        if(expiredValEl) expiredValEl.textContent = activeReagents.filter(r => moment(r.expiry_date).isBefore(today)).length;
    }

    // --- Filter Dropdown Population ---
  function populateAnalyzerDropdown(selectElement, includeAllOption = true, defaultAnalyzersList = ["Dimension", "Vitrous CHM", "Vitrous IMMU", "Advia CP", "Sysmex", "Biorad", "Other"]) {
    if (!selectElement) return;
    const currentVal = selectElement.value; // Preserve current selection if possible
    selectElement.innerHTML = includeAllOption ? '<option value="">All Analyzers</option>' : '<option value="">Select Analyzer</option>';

    let analyzersFromCache = [...new Set(reagentsCache.map(r => r.analyzer).filter(Boolean))];
    let combinedAnalyzers = [...new Set([...defaultAnalyzersList, ...analyzersFromCache])].sort();

    combinedAnalyzers.forEach(a => {
        const option = new Option(a, a);
        selectElement.add(option);
    });

    // Try to restore previous selection if it's still valid
    if (Array.from(selectElement.options).some(opt => opt.value === currentVal)) {
        selectElement.value = currentVal;
    } else if (!includeAllOption && selectElement.options.length > 1) { // if not "All" and has actual options
        // selectElement.selectedIndex = 0; // Default to "Select Analyzer" if no value preserved
    } else if (includeAllOption) {
        // selectElement.value = ""; // Default to "All Analyzers"
    }
}

    function populateAnalyzerFilter() { populateAnalyzerDropdown(document.getElementById('filter-analyzer'), true); }
    
    function populateReagentDropdown(selectElement, includeAllOption = true, filterFn = (r => !r.is_deleted)) {
        if (!selectElement) return;
        const currentVal = selectElement.value;
        selectElement.innerHTML = includeAllOption ? '<option value="">All Reagents</option>' : '<option value="">Select Reagent</option>';
        
        reagentsCache
            .filter(filterFn) // Apply custom filter, e.g. only non-deleted
            .sort((a,b) => a.name.localeCompare(b.name))
            .forEach(r => {
                 const optionText = `${r.name} (Lot: ${r.lot_number || 'N/A'}) ${r.is_deleted ? '[DELETED]' : ''}`;
                 selectElement.add(new Option(optionText, r.id));
            });
        
        if (Array.from(selectElement.options).some(opt => opt.value === currentVal)) {
            selectElement.value = currentVal;
        } else if (!includeAllOption && selectElement.options.length > 0) {
             selectElement.selectedIndex = 0;
        }
    }

    function populateConsumptionReagentFilter() { populateReagentDropdown(document.getElementById('consumption-filter-reagent'), true, () => true); } // Show all, including deleted for filtering history
    function populateStockLogReagentFilter() { populateReagentDropdown(document.getElementById('stocklog-filter-reagent'), true, () => true); } // Show all

    // --- Filtering Logic for Main Tables ---
    function filterReagentLogic(reagent) {
        const nameFilter = document.getElementById('filter-name').value.toLowerCase();
        const lotFilter = document.getElementById('filter-lot').value.toLowerCase();
        const analyzerFilter = document.getElementById('filter-analyzer').value;
        const statusFilter = document.getElementById('filter-status').value;
        const expiryStartFilter = document.getElementById('filter-expiry-start').value;
        const expiryEndFilter = document.getElementById('filter-expiry-end').value;

        if (nameFilter && !reagent.name.toLowerCase().includes(nameFilter)) return false;
        if (lotFilter && !(reagent.lot_number || '').toLowerCase().includes(lotFilter)) return false;
        if (analyzerFilter && reagent.analyzer !== analyzerFilter) return false;
        
        const today = moment().startOf('day');
        const thirtyDaysFromNow = moment().add(30, 'days').endOf('day');
        const expiryDateMoment = moment(reagent.expiry_date);

        if (statusFilter) {
            if (statusFilter === 'expired' && !expiryDateMoment.isBefore(today)) return false;
            if (statusFilter === 'expiring' && !expiryDateMoment.isBetween(today, thirtyDaysFromNow, undefined, '[]')) return false;
            if (statusFilter === 'ok' && (expiryDateMoment.isBefore(today) || expiryDateMoment.isBetween(today, thirtyDaysFromNow, undefined, '[]'))) return false;
        }
        if (expiryStartFilter && !expiryDateMoment.isSameOrAfter(expiryStartFilter)) return false;
        if (expiryEndFilter && !expiryDateMoment.isSameOrBefore(expiryEndFilter)) return false;
        return true;
    }
    function applyReagentFilters() { populateReagentsTable(); }


  function clearReagentFilters(triggerTablePopulation = true) {
    const nameFilterEl = document.getElementById('filter-name');
    const lotFilterEl = document.getElementById('filter-lot');
    const analyzerFilterEl = document.getElementById('filter-analyzer');
    const statusFilterEl = document.getElementById('filter-status');
    const expiryStartEl = document.getElementById('filter-expiry-start');
    const expiryEndEl = document.getElementById('filter-expiry-end');

    if(nameFilterEl) nameFilterEl.value = ''; 
    if(lotFilterEl) lotFilterEl.value = '';
    if(analyzerFilterEl) analyzerFilterEl.value = ''; 
    if(statusFilterEl) statusFilterEl.value = '';
    if(expiryStartEl) expiryStartEl.value = ''; 
    if(expiryEndEl) expiryEndEl.value = '';
    
    if (triggerTablePopulation) {
        populateReagentsTable(); // Refresh the table with cleared filters
    }
}


    function filterConsumptionLogic(record) {
        const startDate = document.getElementById('consumption-filter-start').value;
        const endDate = document.getElementById('consumption-filter-end').value;
        const reagentIdFilter = document.getElementById('consumption-filter-reagent').value;
        const notesFilter = document.getElementById('consumption-filter-notes').value.toLowerCase();
        if (startDate && record.date < startDate) return false;
        if (endDate && record.date > endDate) return false;
        if (reagentIdFilter && record.reagent_id.toString() !== reagentIdFilter.toString()) return false;
        const combinedNotes = `${record.notes || ''} ${record.overall_notes || ''}`.toLowerCase();
        if (notesFilter && !combinedNotes.includes(notesFilter)) return false;
        return true;
    }
    function applyConsumptionFilters() { populateConsumptionTable(); }
    function clearConsumptionFilters() {
        if(document.getElementById('consumption-filter-start')) document.getElementById('consumption-filter-start').value = ''; 
        if(document.getElementById('consumption-filter-end')) document.getElementById('consumption-filter-end').value = '';
        if(document.getElementById('consumption-filter-reagent')) document.getElementById('consumption-filter-reagent').value = ''; 
        if(document.getElementById('consumption-filter-notes')) document.getElementById('consumption-filter-notes').value = '';
        populateConsumptionTable();
    }
    function filterStockLogLogic(log) {
        const startDate = document.getElementById('stocklog-filter-start').value;
        const endDate = document.getElementById('stocklog-filter-end').value;
        const reagentIdFilter = document.getElementById('stocklog-filter-reagent').value;
        if (startDate && log.date_received < startDate) return false;
        if (endDate && log.date_received > endDate) return false;
        if (reagentIdFilter && log.reagent_id.toString() !== reagentIdFilter.toString()) return false;
        return true;
    }
    function applyStockLogFilters() { populateStockLogTable(); }
    function clearStockLogFilters() {
        if(document.getElementById('stocklog-filter-start')) document.getElementById('stocklog-filter-start').value = ''; 
        if(document.getElementById('stocklog-filter-end')) document.getElementById('stocklog-filter-end').value = '';
        if(document.getElementById('stocklog-filter-reagent')) document.getElementById('stocklog-filter-reagent').value = '';
        populateStockLogTable();
    }


    // --- Bulk Actions for Main Reagent Table ---
    function handleSelectAllReagentsChange(event) {
        const checkboxes = document.querySelectorAll('#reagents-table-body .reagent-row-checkbox:not([disabled])');
        checkboxes.forEach(checkbox => checkbox.checked = event.target.checked);
        updateReagentBulkActionVisibility();
    }
    function updateReagentBulkActionVisibility() {
        const anyChecked = Array.from(document.querySelectorAll('#reagents-table-body .reagent-row-checkbox')).some(cb => cb.checked);
        const bulkActionsContainer = document.getElementById('reagent-bulk-actions-container');
        if(bulkActionsContainer) bulkActionsContainer.classList.toggle('hidden', !anyChecked);
        
        // Re-attach listeners to dynamically added checkboxes if rows are repopulated often,
        // or ensure this is called after table population.
        // For now, assuming listeners on checkboxes in populateReagentsTable are sufficient if they call this.
        document.querySelectorAll('#reagents-table-body .reagent-row-checkbox').forEach(cb => {
            // cb.removeEventListener('change', updateReagentBulkActionVisibility); // Avoid duplicates if called multiple times
            cb.addEventListener('change', updateReagentBulkActionVisibility);
        });
    }
    async function handleReagentBulkAction() {
        const actionSelect = document.getElementById('reagent-bulk-action-select');
        if(!actionSelect) return;
        const action = actionSelect.value;
        const selectedIds = Array.from(document.querySelectorAll('#reagents-table-body .reagent-row-checkbox:checked')).map(cb => cb.dataset.id);
        
        if (!action || selectedIds.length === 0) { 
            showAlert('Please select an action and at least one reagent.', 'warning'); return; 
        }
        if (action === 'soft-delete') {
            showDeleteConfirmation(selectedIds, 'reagent-bulk-soft-delete', false); // Pass array of IDs
        }
        actionSelect.value = ""; // Reset select
    }

    // --- Reporting Functions ---
    function exportToExcel(data, filename) {
         try {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
            XLSX.writeFile(workbook, `${filename}_${formatDate(new Date(), 'YYYYMMDD')}.xlsx`);
            showAlert('Report exported to Excel successfully.', 'success');
        } catch (error) { console.error("Excel export error:", error); showAlert('Failed to export to Excel.', 'error');}
    }
    async function exportToJPG(elementOrData, filename, reportType) {
        showLoading();
        try {
            let elementToCapture; let tempTableCreated = false;
            const renderAreaId = `${reportType}-report-render-area`;
            const renderArea = document.getElementById(renderAreaId);

            if (typeof elementOrData === 'string') { // If elementId is passed
                elementToCapture = document.getElementById(elementOrData); 
            } else { // If data array is passed
                if (!renderArea) { showAlert('Render area for JPG report not found.', 'error'); hideLoading(); return; }
                renderArea.innerHTML = ''; // Clear previous
                const tempTable = document.createElement('table');
                tempTable.style.borderCollapse = "collapse"; tempTable.style.width = "95%"; tempTable.style.margin = "10px auto";
                tempTable.style.fontSize = "12px"; // Smaller font for better fit
                
                const a_thead = tempTable.createTHead(); const headerRow = a_thead.insertRow();
                if (elementOrData.length > 0) {
                    Object.keys(elementOrData[0] || {}).forEach(key => {
                        const th = document.createElement('th'); th.textContent = key;
                        th.style.border = "1px solid #ccc"; th.style.padding = "6px"; th.style.backgroundColor = "#e9ecef";
                        th.style.textAlign = "left";
                        headerRow.appendChild(th);
                    });
                }
                const a_tbody = tempTable.createTBody();
                elementOrData.forEach(rowData => {
                    const row = a_tbody.insertRow();
                    Object.values(rowData).forEach(value => {
                        const cell = row.insertCell(); cell.textContent = value;
                        cell.style.border = "1px solid #ccc"; cell.style.padding = "6px";
                    });
                });
                renderArea.appendChild(tempTable); elementToCapture = tempTable;
                renderArea.classList.remove('hidden'); tempTableCreated = true;
            }
            if (!elementToCapture) { showAlert('Element to capture for JPG not found.', 'error'); hideLoading(); return; }
            
            const canvas = await html2canvas(elementToCapture, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false });
            const dataUrl = canvas.toDataURL('image/jpeg', 0.92); // Use JPEG for smaller size
            const link = document.createElement('a'); link.href = dataUrl;
            link.download = `${filename}_${formatDate(new Date(), 'YYYYMMDD')}.jpg`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showAlert('Report exported to JPG successfully.', 'success');
            if (tempTableCreated && renderArea) { renderArea.innerHTML = ''; renderArea.classList.add('hidden');}
        } catch (err) { console.error('Error exporting to JPG:', err); showAlert('Failed to export to JPG. Check console.', 'error');
        } finally { hideLoading(); }
    }
    function generateStockReport(isJpg = false) {
        const activeReagents = reagentsCache.filter(r => !r.is_deleted);
        const today = moment().startOf('day'); const thirtyDaysFromNow = moment().add(30, 'days').endOf('day');
        const data = activeReagents.map(reagent => {
            let status = 'OK'; const expiryDateMoment = moment(reagent.expiry_date);
            if (expiryDateMoment.isBefore(today)) status = 'Expired';
            else if (expiryDateMoment.isBetween(today, thirtyDaysFromNow, undefined, '[]')) status = 'Expiring Soon';
            return { 
                'Reagent Name': reagent.name, 
                'Lot Number': reagent.lot_number || '-', 
                'Analyzer': reagent.analyzer, 
                'Current Stock': reagent.current_stock, 
                'Unit': reagent.unit, 
                'Expiry Date': formatDate(reagent.expiry_date), 
                'Storage': reagent.storage_conditions || '-', 
                'Status': status, 
                // 'Notes': reagent.notes || '' // Optional: can make table too wide for JPG
            };
        }).sort((a,b) => a['Reagent Name'].localeCompare(b['Reagent Name']));
        if (isJpg) exportToJPG(data, 'Reagent_Stock_Report', 'stock'); else exportToExcel(data, 'Reagent_Stock_Report');
    }
    function generateConsumptionReport(isJpg = false) {
        const startDate = document.getElementById('report-consumption-start-date').value;
        const endDate = document.getElementById('report-consumption-end-date').value;
        if (!startDate || !endDate) { showAlert("Please select both start and end dates for consumption report.", "warning"); return; }

        let filteredConsumption = consumptionCache.filter(c => !c.is_deleted);
        if (startDate) filteredConsumption = filteredConsumption.filter(c => c.date >= startDate);
        if (endDate) filteredConsumption = filteredConsumption.filter(c => c.date <= endDate);
        
        const data = filteredConsumption.map(record => {
            const reagent = reagentsCache.find(r => r.id.toString() === record.reagent_id.toString()); 
            return { 
                'Date': formatDate(record.date), 
                'Reagent Name': reagent ? reagent.name : `Unknown (ID ${record.reagent_id})`, 
                'Lot #': reagent ? (reagent.lot_number || '-') : '-', 
                'Quantity': record.quantity, 
                'Unit': record.unit, 
                'Notes': (record.notes || '') + (record.overall_notes ? (record.notes ? '; ' : '') + record.overall_notes : '') || '-'
            };
        }).sort((a,b) => new Date(a.Date) - new Date(b.Date) || a['Reagent Name'].localeCompare(b['Reagent Name']));
        if (data.length === 0) { showAlert("No consumption data found for the selected period.", "info"); return; }
        if (isJpg) exportToJPG(data, 'Consumption_History_Report', 'consumption'); else exportToExcel(data, 'Consumption_History_Report');
    }
    function generateExpiryReport(isJpg = false) {
        const periodSelect = document.getElementById('expiry-period');
        if(!periodSelect) return;
        const period = periodSelect.value;
        const today = moment().startOf('day'); let targetExpiryDate = null;
        
        if (period !== 'all') targetExpiryDate = moment().add(parseInt(period), 'days').endOf('day');
        
        const expiringReagents = reagentsCache.filter(reagent => {
            if (reagent.is_deleted) return false;
            const expiryDateMoment = moment(reagent.expiry_date);
            if (expiryDateMoment.isBefore(today)) return false; // Exclude already expired for "future expiry" report
            if (targetExpiryDate) return expiryDateMoment.isSameOrBefore(targetExpiryDate);
            return true; // "all" future expiry
        });
        const data = expiringReagents.map(reagent => ({ 
            'Reagent Name': reagent.name, 
            'Lot Number': reagent.lot_number || '-', 
            'Analyzer': reagent.analyzer, 
            'Current Stock': reagent.current_stock, 
            'Unit': reagent.unit, 
            'Expiry Date': formatDate(reagent.expiry_date) 
        })).sort((a,b) => new Date(a['Expiry Date']) - new Date(b['Expiry Date']) || a['Reagent Name'].localeCompare(b['Reagent Name']));
        if (data.length === 0) { showAlert("No reagents found expiring in the selected period.", "info"); return; }
        if (isJpg) exportToJPG(data, `Expiry_Report_${period}_days`, 'expiry'); else exportToExcel(data, `Expiry_Report_${period}_days`);
    }


    // --- Analyzer Add/Delete in Modal Dropdown (Session Only) ---
    function addAnalyzerOptionToDropdown(selectElement, optionValue, optionText, selectAfterAdd = false) {
        if (!selectElement) { console.error("Target select element not found for adding analyzer option!"); return; }
        if (!optionValue || !optionText) { console.warn("Cannot add option: value and text are required."); return; }
        
        const normalizedOptionValue = optionValue.trim().toLowerCase();
        let exists = Array.from(selectElement.options).some(opt => opt.value.trim().toLowerCase() === normalizedOptionValue);
        
        if (exists) { showAlert(`Analyzer option "${optionText}" already exists in this list.`, 'info'); return; }
        
        const newOption = new Option(optionText.trim(), optionValue.trim());
        selectElement.add(newOption);
        if (selectAfterAdd) selectElement.value = optionValue.trim();
        showAlert(`Analyzer "${optionText}" added to the list for this session.`, 'success');
    }

    function deleteSelectedAnalyzerOptionFromDropdown(selectElement) {
        if (!selectElement) return;
        const selectedIndex = selectElement.selectedIndex;
        if (selectedIndex === -1 || selectElement.options[selectedIndex].value === "") {
            showAlert("Please select an analyzer from the dropdown to delete.", 'warning'); return;
        }
        
        const optionToRemove = selectElement.options[selectedIndex];
        // Optional: Protect core default values from being removed, or always allow removal for session.
        // const protectedValues = ["Other"]; // Example: "Other" cannot be removed
        // if (protectedValues.includes(optionToRemove.value)) {
        //     showAlert(`Analyzer "${optionToRemove.text}" is a core option and cannot be removed.`, 'info'); return;
        // }

        if (confirm(`Are you sure you want to remove analyzer option "${optionToRemove.text}" from this list for this session?`)) {
            selectElement.remove(selectedIndex);
            selectElement.selectedIndex = 0; // Reset to "Select Analyzer" or first valid option
            showAlert(`Analyzer "${optionToRemove.text}" removed from the list for this session.`, 'success');
        }
    }
    // --- END OF SCRIPT ---
    </script>
</body>
</html>
